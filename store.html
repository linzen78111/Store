<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>寄杯管理小工具 - OPENPOINT風格</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0078d4">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    /* 字體與背景 */
  body {
    font-family: "Noto Sans TC", sans-serif;
    background: linear-gradient(270deg, #ff9a9e, #fad0c4, #fad0c4, #a18cd1, #fbc2eb);
    background-size: 1000% 1000%;
    animation: gradientShift 30s ease infinite;
    transition: background 0.5s ease;
      color: #333;
      /* 使用 Flexbox 佈局 */
      display: flex;
      flex-direction: column;
  }

  /* 更新加載動畫 */
  .update-loading {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 2000;
    justify-content: center;
    align-items: center;
    flex-direction: column;
  }

  .update-loading.show {
    display: flex;
    animation: fadeIn 0.3s ease-in-out;
  }

  .update-loading-spinner {
    width: 80px;
    height: 80px;
    position: relative;
    margin-bottom: 20px;
  }

  .update-loading-spinner::before,
  .update-loading-spinner::after {
    content: '';
    position: absolute;
    border-radius: 50%;
    animation: updateSpinner 1.5s linear infinite;
  }

  .update-loading-spinner::before {
    width: 100%;
    height: 100%;
    border: 4px solid transparent;
    border-top-color: #0078d4;
    border-right-color: #0078d4;
    animation-delay: -0.5s;
  }

  .update-loading-spinner::after {
    width: 70%;
    height: 70%;
    top: 15%;
    left: 15%;
    border: 4px solid transparent;
    border-top-color: #fad0c4;
    border-right-color: #fad0c4;
  }

  .update-loading-text {
    color: white;
    font-size: 1.2rem;
    text-align: center;
    margin-top: 20px;
    animation: updateTextPulse 1.5s ease-in-out infinite;
  }

  .update-loading-progress {
    width: 200px;
    height: 4px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 2px;
    margin-top: 15px;
    overflow: hidden;
  }

  .update-loading-progress-bar {
    width: 0%;
    height: 100%;
    background: #0078d4;
    animation: updateProgress 2s ease-in-out infinite;
  }

  @keyframes updateSpinner {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }

  @keyframes updateTextPulse {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: 0.7;
    }
  }

  @keyframes updateProgress {
    0% {
      width: 0%;
    }
    50% {
      width: 100%;
    }
    100% {
      width: 100%;
    }
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  /* 更新 Modal 動畫效果 */
  #updateModal .modal-dialog {
    transform: scale(0.7);
    opacity: 0;
    transition: all 0.3s ease-in-out;
  }

  #updateModal.show .modal-dialog {
    transform: scale(1);
    opacity: 1;
  }

  /* 更新按鈕動畫 */
  #updateModal .btn-primary {
    position: relative;
    overflow: hidden;
  }

  #updateModal .btn-primary::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 5px;
    height: 5px;
    background: rgba(255, 255, 255, 0.5);
    opacity: 0;
    border-radius: 100%;
    transform: scale(1, 1) translate(-50%);
    transform-origin: 50% 50%;
  }

  #updateModal .btn-primary:focus:not(:active)::after {
    animation: ripple 1s ease-out;
  }

  @keyframes ripple {
    0% {
      transform: scale(0, 0);
      opacity: 0.5;
    }
    100% {
      transform: scale(20, 20);
      opacity: 0;
    }
  }

  /* 版本號更新動畫 */
  #updateModal .version-update {
    animation: versionPulse 2s infinite;
  }

  @keyframes versionPulse {
    0% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.05);
    }
    100% {
      transform: scale(1);
    }
  }

  /* 確保更新 Modal 顯示在最上層 */
  #updateModal {
    z-index: 1060 !important;
  }

  @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* 卡片 */
    .card {
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .card:hover {
      transform: scale(1.03);
      box-shadow: 0 8px 20px rgba(0, 123, 255, 0.25);
    }

    /* 標題 */
    h1 {
      color: #1f3b73; /* 深藍 */
      font-weight: 700;
    }

    /* OPENPOINT 主色調按鈕 */
    .btn-primary {
      background-color: #0078d4;
      border-color: #0078d4;
      font-weight: 600;
      border-radius: 12px;
      transition: background-color 0.3s ease;
    }
    .btn-primary:hover {
      background-color: #005a9e;
      border-color: #005a9e;
    }

    /* 其他按鈕色彩調整 */
    .btn-success {
      background-color: #28a745;
      border-radius: 12px;
      font-weight: 600;
    }
    .btn-success:hover {
      background-color: #1e7e34;
    }
    .btn-warning {
      background-color: #ffc107;
      border-radius: 12px;
      font-weight: 600;
      color: #212529;
    }
    .btn-warning:hover {
      background-color: #e0a800;
      color: #212529;
    }
    .btn-info {
      background-color: #17a2b8;
      border-radius: 12px;
      font-weight: 600;
    }
    .btn-info:hover {
      background-color: #117a8b;
    }
    .btn-secondary {
      border-radius: 12px;
      font-weight: 600;
    }

    /* 警示徽章：低杯數紅標 */
    .badge-low {
      background-color: #dc3545 !important; /* 紅色 */
      color: white;
      font-weight: 700;
      box-shadow: 0 0 5px rgba(220, 53, 69, 0.7);
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 5px rgba(220, 53, 69, 0.7); }
      50% { box-shadow: 0 0 15px rgba(220, 53, 69, 1); }
    }

    /* 搜尋欄陰影 */
    #searchInput {
      border-radius: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    /* 手機友善間距 */
    .btn-group {
      gap: 10px;
      flex-wrap: wrap;
    }

    /* 新增樣式 */
    .toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1050;
    }

    .customer-card {
      transition: all 0.3s ease;
    }

    .customer-card:hover {
      transform: translateY(-2px);
    }

    .stats-badge {
      font-size: 0.8rem;
      padding: 0.25rem 0.5rem;
      margin-left: 0.5rem;
    }

    .note-badge {
      background-color: #6c757d;
      color: white;
      font-size: 0.8rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      margin-left: 0.5rem;
      cursor: pointer;
    }

    .note-badge:hover {
      background-color: #5a6268;
    }

    @media (max-width: 576px) {
      .btn-group {
        flex-direction: column;
        width: 100%;
      }
      .btn-group .btn {
        width: 100%;
        margin: 2px 0;
        padding: .25rem .5rem;
        font-size: .875rem;
      }
      .customer-card .d-flex {
        flex-direction: column;
        align-items: stretch !important;
      }
      .customer-card .btn-group {
        margin-top: 10px;
      }
      .customer-card .d-flex > div:last-child {
        gap: 5px !important;
      }
    }

    /* 進一步縮小顧客卡片內的按鈕 */
    .customer-card .btn-group .btn,
    .customer-card .btn-outline-info.btn-sm,
    .customer-card .btn-outline-danger.btn-sm {
      padding: .2rem .4rem; /* 稍微縮小內距 */
      font-size: .8rem; /* 縮小字體 */
      border-radius: 8px; /* 調整圓角 */
    }

    .customer-card .d-flex > div:last-child {
      gap: 8px; /* 調整按鈕之間的間距 */
    }

    /* 新增樣式以調整卡片內部結構間距 */
    .customer-card > div:first-child {
        margin-bottom: 10px; /* 增加名稱/備註區域和按鈕區域之間的間距 */
    }

    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
    }

    .container {
        flex-grow: 1; /* 讓容器佔據剩餘空間 */
        display: flex; /* 使用 Flexbox 佈局內部內容 */
        flex-direction: column;
        padding-top: 1.5rem !important; /* 恢復頂部內距 */
        padding-bottom: 1.5rem !important; /* 恢復底部內距 */
        overflow: hidden; /* 防止內容溢出容器導致整體滾動 */
    }

    .main-content {
        flex-grow: 1; /* 讓主要內容區塊佔據剩餘空間 */
        overflow-y: auto; /* 垂直方向可滾動 */
        padding-top: 1rem; /* 為主要內容區塊添加頂部內距 */
    }

    /* 深色模式 */
    .dark-mode {
      background: linear-gradient(270deg, #2c3e50, #34495e, #2c3e50, #1a252f, #1a252f); /* 更深的漸變背景 */
      color: #ecf0f1; /* 淺灰文字 */
    }

    .dark-mode h1 {
      color: #bdc3c7; /* 較淺的標題顏色 */
    }

    .dark-mode .card {
      background-color: #34495e; /* 深藍背景 */
      color: #ecf0f1; /* 淺灰文字 */
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); /* 調整陰影 */
    }

    .dark-mode .card:hover {
       box-shadow: 0 8px 20px rgba(0, 123, 255, 0.1); /* 調整陰影 */
    }

    .dark-mode .badge-low {
      background-color: #e74c3c !important; /* 調整紅色 */
    }

    .dark-mode .bg-primary {
       background-color: #3498db !important; /* 調整藍色 */
    }

    .dark-mode .btn-primary {
        background-color: #3498db; /* 調整按鈕藍色 */
        border-color: #3498db;
    }
    .dark-mode .btn-primary:hover {
        background-color: #2980b9; /* 調整 hover 藍色 */
        border-color: #2980b9;
    }

     .dark-mode .btn-success {
      background-color: #2ecc71; /* 調整按鈕綠色 */
      border-color: #2ecc71;
    }
    .dark-mode .btn-success:hover {
      background-color: #27ae60; /* 調整 hover 綠色 */
      border-color: #27ae60;
    }

     .dark-mode .btn-secondary {
        background-color: #7f8c8d; /* 調整按鈕灰色 */
        border-color: #7f8c8d;
        color: #ecf0f1; /* 淺灰文字 */
    }
     .dark-mode .btn-secondary:hover {
        background-color: #95a5a6; /* 調整 hover 灰色 */
        border-color: #95a5a6;
    }

    .dark-mode .btn-warning {
      background-color: #f1c40f; /* 調整按鈕黃色 */
      border-color: #f1c40f;
      color: #333; /* 深色文字 */
    }
    .dark-mode .btn-warning:hover {
      background-color: #f39c12; /* 調整 hover 黃色 */
      border-color: #f39c12;
    }

    .dark-mode .btn-info {
      background-color: #3498db; /* 調整按鈕淺藍 */
      border-color: #3498db;
    }
     .dark-mode .btn-info:hover {
      background-color: #2980b9; /* 調整 hover 淺藍 */
      border-color: #2980b9;
    }

     .dark-mode .btn-outline-info {
      color: #3498db; /* 調整外框按鈕顏色 */
      border-color: #3498db;
    }
     .dark-mode .btn-outline-info:hover {
       color: #ecf0f1; /* 調整外框按鈕 hover 顏色 */
       background-color: #3498db;
       border-color: #3498db;
    }

    .dark-mode .btn-outline-danger {
       color: #e74c3c; /* 調整外框按鈕顏色 */
       border-color: #e74c3c;
    }
     .dark-mode .btn-outline-danger:hover {
        color: #ecf0f1; /* 調整外框按鈕 hover 顏色 */
        background-color: #e74c3c;
        border-color: #e74c3c;
    }

    .dark-mode #searchInput {
        background-color: #2c3e50; /* 深色背景 */
        color: #ecf0f1; /* 淺灰文字 */
        box-shadow: 0 2px 6px rgba(0,0,0,0.2); /* 調整陰影 */
        border-color: #34495e; /* 調整邊框顏色 */
    }

    .dark-mode .alert-info {
        background-color: #3498db;
        color: #ecf0f1;
        border-color: #2980b9;
    }

     .dark-mode .alert-success {
        background-color: #2ecc71;
        color: #ecf0f1;
        border-color: #27ae60;
    }

     .dark-mode .alert-danger {
        background-color: #e74c3c;
        color: #ecf0f1;
        border-color: #c0392b;
    }

    .dark-mode .modal-content {
        background-color: #2c3e50; /* 深色背景 */
        color: #ecf0f1; /* 淺灰文字 */
    }

    .dark-mode .modal-header {
        border-color: #34495e; /* 調整邊框顏色 */
    }

     .dark-mode .modal-footer {
        border-color: #34495e; /* 調整邊框顏色 */
    }

    .dark-mode .list-group-item {
        background-color: #34495e; /* 深色背景 */
        color: #ecf0f1; /* 淺灰文字 */
        border-color: rgba(255, 255, 255, 0.1); /* 調整邊框顏色 */
    }

    .dark-mode .list-group-item-action:hover {
        background-color: #2c3e50; /* 深色 hover 背景 */
    }

    .dark-mode .form-label {
        color: #bdc3c7; /* 調整標籤顏色 */
    }

    .dark-mode .form-control {
        background-color: #34495e; /* 深色背景 */
        color: #ecf0f1; /* 淺灰文字 */
        border-color: #34495e; /* 調整邊框顏色 */
    }

    .dark-mode .form-control::placeholder {
        color: #bdc3c7; /* 調整 placeholder 顏色 */
        opacity: 0.7; /* 調整透明度 */
    }

    .dark-mode .text-muted {
        color: #bdc3c7 !important; /* 調整靜默文字顏色 */
    }

    .dark-mode .toast-body {
       color: #ecf0f1; /* 淺灰文字 */
    }

    .dark-mode .note-badge {
       background-color: #5a6268; /* 調整備註徽章顏色 */
    }
     .dark-mode .note-badge:hover {
        background-color: #6c757d; /* 調整備註徽章 hover 顏色 */
    }
  </style>
</head>
<body class="container py-4">
  <!-- 更新加載動畫 -->
  <div class="update-loading" id="updateLoading">
    <div class="update-loading-spinner"></div>
    <div class="update-loading-text">正在更新應用程式...</div>
    <div class="update-loading-progress">
      <div class="update-loading-progress-bar"></div>
    </div>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">☕ 寄杯管理小工具</h1>
    <div class="mt-2 mt-sm-0">
      <button class="btn btn-sm btn-outline-primary" onclick="showQuickSearch()">🔍 快速搜尋</button>
    </div>
  </div>

  <!-- 統計資訊 -->
  <div class="alert alert-info mb-3" role="alert">
    <div class="d-flex justify-content-between align-items-center flex-wrap">
      <div>
        <span class="badge bg-primary me-2">總顧客數：<span id="totalCustomers">0</span></span>
        <span class="badge bg-success me-2">總杯數：<span id="totalCups">0</span></span>
        <span class="badge bg-warning text-dark">最後更新：<span id="lastUpdate">-</span></span>
      </div>
    </div>
  </div>

  <!-- 將搜尋、按鈕和列表包裝在一個新的 div 中 -->
  <div class="main-content">
  <!-- 搜尋欄位 -->
  <div class="mb-3">
    <input id="searchInput" class="form-control" placeholder="🔍 搜尋顧客名稱" oninput="render()" />
  </div>

  <!-- 按鈕列 -->
  <div class="mb-3 d-flex flex-wrap gap-2 btn-group">
    <button class="btn btn-info" onclick="backup()">💾 手動備份</button>
    <input type="file" id="importInput" accept=".json" style="display:none" onchange="importBackup(event)" />
    <button class="btn btn-warning" onclick="document.getElementById('importInput').click()">📥 匯入備份</button>
    <button class="btn btn-secondary" type="button" data-bs-toggle="modal" data-bs-target="#settingsModal">
      ⚙️ 設定
    </button>
  </div>

  <!-- 顧客列表 -->
  <div id="customerList" class="vstack gap-3"></div>
  </div>

  <!-- Toast 提示容器 -->
  <div class="toast-container"></div>

  <!-- 新增自訂的更新提示 Modal -->
  <div id="updateModal" class="modal fade" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4 shadow-sm">
        <div class="modal-header">
          <h5 class="modal-title" id="updateModalLabel">
            <span class="version-update">✨</span> 新版本可用！
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="version-update">發現新的應用程式版本，建議立即更新以取得最新功能及修正。</p>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <p class="mb-0">目前版本：<span id="currentVersionModal" class="badge bg-secondary">1.0.0</span></p>
            <span class="version-update">→</span>
            <p class="mb-0">新版本：<span id="newVersionModal" class="badge bg-primary">-</span></p>
          </div>
          <small class="text-muted d-block">（更新需要重新載入頁面）</small>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">稍後再說</button>
          <button type="button" class="btn btn-primary version-update" onclick="applyUpdate()">
            <span class="me-1">🔄</span>立即更新
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 自動備份已完成 Modal -->
  <div id="autoBackupReadyModal" class="modal fade" tabindex="-1" aria-labelledby="autoBackupReadyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4 shadow-sm">
        <div class="modal-header">
          <h5 class="modal-title" id="autoBackupReadyModalLabel">自動備份完成</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          每小時自動備份已完成，是否要下載最新的備份檔案？
          <p class="text-muted mt-2 mb-0">（請務必將備份檔案妥善保存！）</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="triggerAutoBackupDownload()">下載</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 備份提示 Modal -->
  <div id="backupNoticeModal" class="modal fade" tabindex="-1" aria-labelledby="backupNoticeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4 shadow-sm">
        <div class="modal-header">
          <h5 class="modal-title" id="backupNoticeModalLabel">備份提示</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="backupNoticeContent"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">好的</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 確認提示 Modal -->
  <div id="confirmModal" class="modal fade" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4 shadow-sm">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmModalLabel">請確認</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="confirmMessage"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-danger" id="confirmActionBtn">確定</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 查看歷史 Modal -->
  <div id="historyModal" class="modal fade" tabindex="-1" aria-labelledby="historyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered">
      <div class="modal-content rounded-4 shadow-sm">
        <div class="modal-header">
          <h5 class="modal-title" id="historyModalLabel">📜 顧客歷史紀錄</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="historyContent"></div>
      </div>
    </div>
  </div>

  <!-- 新增顧客 Modal -->
  <div id="addCustomerModal" class="modal fade" tabindex="-1" aria-labelledby="addCustomerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4 shadow-sm">
        <div class="modal-header">
          <h5 class="modal-title" id="addCustomerModalLabel">➕ 新增顧客</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="newCustomerName" class="form-label">顧客名稱</label>
            <input type="text" id="newCustomerName" class="form-control" placeholder="請輸入顧客名稱" />
          </div>
          <div class="mb-3">
            <label for="newCustomerProductType" class="form-label">商品類型</label>
            <select id="newCustomerProductType" class="form-select">
              <option value="鐵觀音">鐵觀音</option>
              <option value="烏龍茶">烏龍茶</option>
              <option value="紅茶">紅茶</option>
              <option value="綠茶">綠茶</option>
              <option value="其他">其他</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="newCustomerNote" class="form-label">備註（選填）</label>
            <textarea id="newCustomerNote" class="form-control" placeholder="可以輸入顧客的特別備註" rows="2"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="addNewCustomer()">新增</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 編輯備註 Modal -->
  <div id="editNoteModal" class="modal fade" tabindex="-1" aria-labelledby="editNoteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4 shadow-sm">
        <div class="modal-header">
          <h5 class="modal-title" id="editNoteModalLabel">📝 編輯備註</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="editCustomerNote" class="form-label">備註內容</label>
            <textarea id="editCustomerNote" class="form-control" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="saveCustomerNote()">儲存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 快速搜尋 Modal -->
  <div id="quickSearchModal" class="modal fade" tabindex="-1" aria-labelledby="quickSearchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4 shadow-sm">
        <div class="modal-header">
          <h5 class="modal-title" id="quickSearchModalLabel">🔍 快速搜尋</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="list-group" id="quickSearchList"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 加多杯 Modal -->
  <div id="addMultipleCupsModal" class="modal fade" tabindex="-1" aria-labelledby="addMultipleCupsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4 shadow-sm">
        <div class="modal-header">
          <h5 class="modal-title" id="addMultipleCupsModalLabel">➕ 加多杯</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="cupsToAddInput" class="form-label">要增加的杯數</label>
            <input type="number" id="cupsToAddInput" class="form-control" value="1" min="1" />
          </div>
          <div class="mb-3">
            <label for="cupsProductType" class="form-label">商品類型</label>
            <select id="cupsProductType" class="form-select">
              <option value="鐵觀音">鐵觀音</option>
              <option value="烏龍茶">烏龍茶</option>
              <option value="紅茶">紅茶</option>
              <option value="綠茶">綠茶</option>
              <option value="其他">其他</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="confirmAddMultipleCups()">確定增加</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 編輯商品類型 Modal -->
  <div id="editProductTypeModal" class="modal fade" tabindex="-1" aria-labelledby="editProductTypeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4 shadow-sm">
        <div class="modal-header">
          <h5 class="modal-title" id="editProductTypeModalLabel">編輯商品類型</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="editProductTypeInput" class="form-label">商品類型名稱</label>
            <input type="text" id="editProductTypeInput" class="form-control">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="saveProductTypeEdit()">儲存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 日結報表 Modal -->
  <div id="dailyReportModal" class="modal fade" tabindex="-1" aria-labelledby="dailyReportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
      <div class="modal-content rounded-4 shadow-sm">
        <div class="modal-header">
          <h5 class="modal-title" id="dailyReportModalLabel">📊 日結報表</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3 d-flex gap-2 align-items-center">
            <label for="dailyReportDate" class="form-label mb-0">選擇日期</label>
            <input type="date" id="dailyReportDate" class="form-control" onchange="updateDailyReport()">
            <button class="btn btn-outline-primary" onclick="showTodayReport()">今天</button>
          </div>
          <div id="dailyReportContent"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 月結報表 Modal -->
  <div id="monthlyReportModal" class="modal fade" tabindex="-1" aria-labelledby="monthlyReportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
      <div class="modal-content rounded-4 shadow-sm">
        <div class="modal-header">
          <h5 class="modal-title" id="monthlyReportModalLabel">📈 月結報表</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3 d-flex gap-2 align-items-center">
            <label for="monthlyReportMonth" class="form-label mb-0">選擇月份</label>
            <input type="month" id="monthlyReportMonth" class="form-control" onchange="updateMonthlyReport()">
            <button class="btn btn-outline-primary" onclick="showCurrentMonthReport()">本月</button>
          </div>
          <div id="monthlyReportContent"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 設定 Modal -->
  <div id="settingsModal" class="modal fade" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4 shadow-sm">
        <div class="modal-header">
          <h5 class="modal-title" id="settingsModalLabel">⚙️ 設定</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="accordion" id="settingsAccordion">
            <!-- 版本更新 -->
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#updateSettings" aria-expanded="true" aria-controls="updateSettings">
                  版本更新
                </button>
              </h2>
              <div id="updateSettings" class="accordion-collapse collapse show" data-bs-parent="#settingsAccordion">
                <div class="accordion-body">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>目前版本：<span id="currentVersion" class="fw-bold">1.0.0</span></span>
                    <small class="text-muted">上次檢查：<span id="lastCheckTime">尚未檢查</span></small>
                  </div>
                  <button type="button" class="btn btn-primary w-100" onclick="checkForUpdates(false)">
                    <i class="bi bi-arrow-clockwise"></i> 檢查更新
                  </button>
                </div>
              </div>
            </div>

            <!-- 基本設定 -->
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#basicSettings" aria-expanded="false" aria-controls="basicSettings">
                  基本設定
                </button>
              </h2>
              <div id="basicSettings" class="accordion-collapse collapse" data-bs-parent="#settingsAccordion">
                <div class="accordion-body">
                  <div class="mb-3">
                    <label for="autoBackupIntervalInput" class="form-label">自動備份間隔 (小時)</label>
                    <input type="number" id="autoBackupIntervalInput" class="form-control" placeholder="1" min="1" />
                  </div>
                  <div class="mb-3 form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="enablePredictiveSorting">
                    <label class="form-check-label" for="enablePredictiveSorting">啟用預測排序</label>
                  </div>
                  <div class="mb-3 form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="enableDarkMode">
                    <label class="form-check-label" for="enableDarkMode">啟用深色模式</label>
                  </div>
                  <div class="mb-3 form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="enableDailyReport">
                    <label class="form-check-label" for="enableDailyReport">啟用日結報表</label>
                  </div>
                   <div class="mb-3 form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="enableMonthlyReport">
                    <label class="form-check-label" for="enableMonthlyReport">啟用月結報表</label>
                  </div>
                  <!-- 其他基本設定 -->
                </div>
              </div>
            </div>

            <!-- 商品類型管理 -->
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#productTypeSettings" aria-expanded="false" aria-controls="productTypeSettings">
                  商品類型管理
                </button>
              </h2>
              <div id="productTypeSettings" class="accordion-collapse collapse" data-bs-parent="#settingsAccordion">
                <div class="accordion-body">
                  <div class="input-group mb-2">
                    <input type="text" id="newProductType" class="form-control" placeholder="輸入新商品類型">
                    <button class="btn btn-outline-primary" onclick="addProductType()">新增</button>
                  </div>
                  <div id="productTypeList" class="list-group">
                    <!-- 商品類型列表將在這裡動態生成 -->
                  </div>
                </div>
              </div>
            </div>

            <!-- 報表設定 -->
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#reportSettings" aria-expanded="false" aria-controls="reportSettings">
                  報表設定
                </button>
              </h2>
              <div id="reportSettings" class="accordion-collapse collapse" data-bs-parent="#settingsAccordion">
                <div class="accordion-body">
                  <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" onclick="hideSettingsModal(); showDailyReport();">📊 查看日結報表</button>
                    <button class="btn btn-outline-primary" onclick="hideSettingsModal(); showMonthlyReport();">📈 查看月結報表</button>
                  </div>
                  <!-- 其他報表設定 -->
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
          <button type="button" class="btn btn-primary" onclick="saveSettings()">儲存設定</button>
        </div>
      </div>
    </div>
  </div>

  <!-- JS 區塊 -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // 全域變數
    let currentEditingCustomer = null;
    let currentCustomerToAddCups = null;
    let autoBackupIntervalId = null; // 用於儲存 setInterval 的 ID

    // 基礎資料操作函數
    function getData() {
      return JSON.parse(localStorage.getItem('cups') || '{}');
    }

    function saveData(data) {
      localStorage.setItem('cups', JSON.stringify(data));
    }

    // UI 輔助函數
    function showToast(message, type = 'success') {
      const toastContainer = document.querySelector('.toast-container');
      const toast = document.createElement('div');
      toast.className = `toast align-items-center text-white bg-${type} border-0`;
      toast.setAttribute('role', 'alert');
      toast.setAttribute('aria-live', 'assertive');
      toast.setAttribute('aria-atomic', 'true');
      
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      `;
      
      toastContainer.appendChild(toast);
      const bsToast = new bootstrap.Toast(toast);
      bsToast.show();
      
      toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
      });
    }

    function updateStats() {
      const data = getData();
      const customers = Object.keys(data);
      const totalCups = customers.reduce((sum, name) => sum + data[name].count, 0);
      
      document.getElementById('totalCustomers').textContent = customers.length;
      document.getElementById('totalCups').textContent = totalCups;
      const now = new Date();
      // 使用本地時間
      const timeStr = now.toLocaleString('zh-TW', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false,
        timeZone: 'Asia/Taipei'
      }).replace(/\//g, '/');
      document.getElementById('lastUpdate').textContent = timeStr;
    }

    // 搜尋相關函數
    function showQuickSearch() {
      const data = getData();
      const list = document.getElementById('quickSearchList');
      list.innerHTML = '';

      Object.keys(data).sort().forEach(name => {
        const item = document.createElement('button');
        item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
        item.innerHTML = `
          <span>${name}</span>
          <span class="badge bg-primary rounded-pill">${data[name].count} 杯</span>
        `;
        item.onclick = () => {
          document.getElementById('searchInput').value = name;
          render();
          bootstrap.Modal.getInstance(document.getElementById('quickSearchModal')).hide();
        };
        list.appendChild(item);
      });
      
      new bootstrap.Modal(document.getElementById('quickSearchModal')).show();
    }

    // 備註相關函數
    function showEditNoteModal(name) {
      currentEditingCustomer = name;
      const data = getData();
      document.getElementById('editCustomerNote').value = data[name].note || '';
      new bootstrap.Modal(document.getElementById('editNoteModal')).show();
    }

    function saveCustomerNote() {
      if (!currentEditingCustomer) return;
      
      const note = document.getElementById('editCustomerNote').value.trim();
      const data = getData();
      data[currentEditingCustomer].note = note;
      saveData(data);
      
      bootstrap.Modal.getInstance(document.getElementById('editNoteModal')).hide();
      showToast('備註已更新');
      render();
    }

    // 顧客管理函數
    function showAddCustomerModal() {
      const modal = new bootstrap.Modal(document.getElementById('addCustomerModal'));
      document.getElementById('newCustomerName').value = '';
      document.getElementById('newCustomerProductType').value = '鐵觀音';
      document.getElementById('newCustomerNote').value = '';
      modal.show();
    }

    function addNewCustomer() {
      const name = document.getElementById('newCustomerName').value.trim();
      const note = document.getElementById('newCustomerNote').value.trim();
      const productType = document.getElementById('newCustomerProductType').value;
      
      if (!name) {
        showToast('請輸入顧客名稱', 'danger');
        return;
      }

      const data = getData();
      if (data[name]) {
        showToast('此顧客已存在', 'danger');
        return;
      }

      data[name] = { 
        count: 0, 
        log: [],
        note: note,
        productType: productType,
        createdAt: new Date().toISOString()
      };
      saveData(data);
      
      const modal = bootstrap.Modal.getInstance(document.getElementById('addCustomerModal'));
      modal.hide();
      
      showToast('顧客新增成功');
      render();
    }

    function addCup(name, quantity = 1) {
      const data = getData();
      if (!data[name]) data[name] = { count: 0, log: [], createdAt: new Date().toISOString() };
      data[name].count += quantity;
      const now = new Date();
      // 使用本地時間
      const timeStr = now.toLocaleString('zh-TW', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false,
        timeZone: 'Asia/Taipei'
      }).replace(/\//g, '/');
      data[name].log.push(`+${quantity} 杯（${timeStr}）`);
      saveData(data);
      showToast(`已為 ${name} 增加 ${quantity} 杯`);
      render();
    }

    function removeCup(name) {
      const data = getData();
      if (!data[name] || data[name].count <= 0) {
        showToast('無法扣除，該顧客尚無杯數', 'danger');
        return;
      }
      data[name].count--;
      const now = new Date();
      // 使用本地時間
      const timeStr = now.toLocaleString('zh-TW', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false,
        timeZone: 'Asia/Taipei'
      }).replace(/\//g, '/');
      data[name].log.push(`-1 杯 ${data[name].productType || '未指定'}（${timeStr}）`);
      saveData(data);
      showToast(`已為 ${name} 扣一杯`);
      render();
    }

    function removeCustomer(name) {
      const confirmModalElement = document.getElementById('confirmModal');
      const confirmMessageElement = document.getElementById('confirmMessage');
      const confirmActionBtn = document.getElementById('confirmActionBtn');

      confirmModalElement.querySelector('.modal-title').textContent = '確認移除';
      confirmMessageElement.innerHTML = `確定要移除顧客 <strong>${name}</strong> 嗎？<br>此操作無法復原！`;
      
      // 移除舊的事件監聽器
      const newConfirmActionBtn = confirmActionBtn.cloneNode(true);
      confirmActionBtn.parentNode.replaceChild(newConfirmActionBtn, confirmActionBtn);

      // 新增新的事件監聽器
      newConfirmActionBtn.addEventListener('click', () => {
      const data = getData();
      delete data[name];
      saveData(data);
        showToast(`已移除顧客 ${name}`);
      render();
        bootstrap.Modal.getInstance(confirmModalElement).hide();
      });

      const confirmModal = new bootstrap.Modal(confirmModalElement);
      confirmModal.show();
    }

    function viewHistory(name) {
      const data = getData();
      const log = data[name]?.log || [];
      document.getElementById('historyContent').innerHTML =
        `<ul class="list-group">${log.map(item => `<li class="list-group-item">${item}</li>`).join('')}</ul>`;
      new bootstrap.Modal(document.getElementById('historyModal')).show();
    }

    // 備份相關函數
    function backup() {
      const data = getData();
      const now = new Date();
      const formattedDate = now.toLocaleString('zh-TW', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      }).replace(/[/:]/g, '-').replace(/\s/g, '_');

      // 讀取當前所有設定
      const currentSettings = {
        autoBackupInterval: localStorage.getItem('autoBackupInterval') || '1',
        predictiveSortingEnabled: localStorage.getItem('predictiveSortingEnabled') || 'false',
        darkModeEnabled: localStorage.getItem('darkModeEnabled') || 'false',
        enableDailyReport: localStorage.getItem('enableDailyReport') || 'false',
        enableMonthlyReport: localStorage.getItem('enableMonthlyReport') || 'false'
      };

      const backupData = {
        version: '1.1', // 更新版本號
        exportDate: now.toISOString(),
        data: data,
        settings: currentSettings,
        totalCustomers: Object.keys(data).length,
        totalCups: Object.values(data).reduce((sum, customer) => sum + customer.count, 0)
      };

      const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `寄杯備份_${formattedDate}.json`;
      a.click();

      showBackupNoticeModal('備份檔案已下載', `檔案名稱：<strong>寄杯備份_${formattedDate}.json</strong><hr><p class="mb-0"><strong>iOS 使用者請注意：</strong><br>1. 點擊下載的檔案<br>2. 選擇「儲存到檔案」<br>3. 選擇「我的 iPhone」或「iCloud 雲碟」<br>4. 建議建立「寄杯備份」資料夾存放<br><br><strong>請務必將備份檔案妥善保存，避免資料遺失！</strong></p>`);
    }

    // 將備份提示改為 Modal
    function showBackupNoticeModal(title, message) {
      const modalElement = document.getElementById('backupNoticeModal');
      const modalTitle = modalElement.querySelector('.modal-title');
      const modalBody = modalElement.querySelector('.modal-body');
      
      modalTitle.textContent = title;
      modalBody.innerHTML = message;
      
      const modal = new bootstrap.Modal(modalElement);
      modal.show();
    }

    function importBackup(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const imported = JSON.parse(e.target.result);
          if (!imported.data) throw new Error('備份格式錯誤：缺少顧客資料');
          
          // 如果備份包含設定，則匯入設定
          if (imported.settings) {
            localStorage.setItem('autoBackupInterval', imported.settings.autoBackupInterval || '1');
            localStorage.setItem('predictiveSortingEnabled', imported.settings.predictiveSortingEnabled || 'false');
            localStorage.setItem('darkModeEnabled', imported.settings.darkModeEnabled || 'false');
            localStorage.setItem('enableDailyReport', imported.settings.enableDailyReport || 'false');
            localStorage.setItem('enableMonthlyReport', imported.settings.enableMonthlyReport || 'false');

            // 應用匯入的設定
            setAutoBackupInterval(parseInt(imported.settings.autoBackupInterval || '1'));
            applyDarkMode(imported.settings.darkModeEnabled === 'true');
          }

          // 匯入顧客資料
          const existing = getData();
          const merged = { ...existing, ...imported.data };
          saveData(merged);
          
          showBackupNoticeModal('匯入成功！', `✅ 已成功匯入 ${Object.keys(imported.data).length} 筆顧客資料${imported.totalCups ? `<br>總杯數：${imported.totalCups} 杯` : ''}`);
          render();
        } catch (err) {
          showBackupNoticeModal('匯入失敗', `❌ ${err.message}`);
          console.error('匯入錯誤:', err);
        }
      };
      reader.readAsText(file);
    }

    // 預測相關函數
    function calculatePredictedNextVisit(customerLog) {
        // 1. 只取提杯記錄
        const removeCupLogs = (customerLog || []).filter(log => {
            if (typeof log === 'string') {
                return log.startsWith('-1 杯');
            } else if (typeof log === 'object' && log !== null && log.type === 'remove') {
                return true;
            }
            return false;
        });

        if (removeCupLogs.length < 2) return null;

        // 解析日期並排序 (從舊到新)
        const dates = removeCupLogs.map(log => {
            let dateString;
            if (typeof log === 'string') {
                const match = log.match(/（(.*?)）/);
                dateString = match ? match[1] : null;
            } else if (typeof log === 'object' && log !== null && log.timestamp) {
                dateString = log.timestamp;
            }
            
            if (!dateString) return null;
            
            const date = new Date(dateString);
            return isNaN(date.getTime()) ? null : date;
        }).filter(date => date !== null).sort((a, b) => a.getTime() - b.getTime());

        // 如果解析出的有效日期少於兩筆，返回 null
        if (dates.length < 2) {
            return null;
        }

        // 計算時間間隔 (毫秒)
        const intervals = [];
        for (let i = 1; i < dates.length; i++) {
            intervals.push(dates[i].getTime() - dates[i - 1].getTime());
        }

        // 如果沒有有效的間隔，返回 null
        if (intervals.length === 0) {
            return null;
        }

        // 計算平均間隔 (毫秒)
        const averageInterval = intervals.reduce((sum, interval) => sum + interval, 0) / intervals.length;

        // 預測下一次來訪日期 = 最後一次提杯日期 + 平均間隔
        const lastVisitDate = dates[dates.length - 1];
        const predictedDate = new Date(lastVisitDate.getTime() + averageInterval);

        return predictedDate;
    }

    // 渲染函數
    function render() {
      const data = getData();
      const list = document.getElementById('customerList');
      const searchKeyword = document.getElementById('searchInput').value.trim().toLowerCase();
      list.innerHTML = '';

      let filteredNames = Object.keys(data).filter(name =>
        name.toLowerCase().includes(searchKeyword)
      );

      // 檢查預測排序設定
      const predictiveSortingEnabled = localStorage.getItem('predictiveSortingEnabled') === 'true';

      let customerPredictions = null; // 將變數聲明移到這裡

      if (predictiveSortingEnabled) {
          // 計算每個顧客的預測日期並儲存起來以便排序
          customerPredictions = filteredNames.map(name => {
              const predictedDate = calculatePredictedNextVisit(data[name].log || []);
              return { name, predictedDate };
          });

          // 根據預測日期排序
          customerPredictions.sort((a, b) => {
              // 沒有預測日期的排在後面
              if (a.predictedDate === null && b.predictedDate === null) return 0;
              if (a.predictedDate === null) return 1;
              if (b.predictedDate === null) return -1;

              // 按預測日期排序 (從早到晚)
              return a.predictedDate.getTime() - b.predictedDate.getTime();
          });

          // 更新 filteredNames 為排序後的名稱列表
          filteredNames = customerPredictions.map(item => item.name);

      } else {
          // 如果預測排序未啟用，按名稱字母順序排序
          filteredNames.sort();
      }

      if (filteredNames.length === 0) {
        list.innerHTML = `
          <div class="text-center">
            <p class="text-muted">找不到符合的顧客</p>
            <button class="btn btn-primary" onclick="showAddCustomerModal()">➕ 新增顧客</button>
          </div>`;
        return;
      }

      // 新增顧客按鈕
      const addButton = document.createElement('div');
      addButton.className = 'text-center mb-3';
      addButton.innerHTML = '<button class="btn btn-primary" onclick="showAddCustomerModal()">➕ 新增顧客</button>';
      list.appendChild(addButton);

      for (const name of filteredNames) {
        const customer = data[name];
        const lowCup = customer.count < 2;

        const card = document.createElement('div');
        card.className = 'card shadow-sm p-3 customer-card';
        card.innerHTML = `
          <div>
            <h5 class="mb-1">${name}：
              <span class="badge ${lowCup ? 'badge-low' : 'bg-primary'}">${customer.count} 杯</span>
              ${customer.note ? `<span class="note-badge" onclick="showEditNoteModal('${name}')">📝</span>` : ''}
            </h5>
            <small class="text-muted d-block mb-2">
              ${customer.productType ? `商品類型：${customer.productType}` : ''}
              ${customer.note ? `<br>${customer.note}` : ''}
            </small>
            ${predictiveSortingEnabled && customerPredictions ? 
                `<small class="text-muted">預測下次：${customerPredictions.find(item => item.name === name)?.predictedDate?.toLocaleString() || '無數據'}</small>` 
                : ''}
          </div>
          <div class="d-flex justify-content-end align-items-center flex-wrap gap-2">
            <div class="btn-group">
              <button class="btn btn-success btn-sm" onclick="showAddMultipleCupsModal('${name}')">➕</button>
              <button class="btn btn-secondary btn-sm" onclick="removeCup('${name}')">➖</button>
            </div>
            <button class="btn btn-outline-info btn-sm" onclick="viewHistory('${name}')">📜 歷史</button>
            <button class="btn btn-outline-danger btn-sm" onclick="removeCustomer('${name}')">🗑️ 移除</button>
          </div>
        `;

        list.appendChild(card);
      }

      updateStats();
    }

    // 加多杯 Modal 相關函數
    function showAddMultipleCupsModal(name) {
      currentCustomerToAddCups = name; // 記錄當前要加杯的顧客
      document.getElementById('cupsToAddInput').value = '1'; // 預設值設為 1
      const modal = new bootstrap.Modal(document.getElementById('addMultipleCupsModal'));
      modal.show();
    }

    function confirmAddMultipleCups() {
      const cupsToAdd = parseInt(document.getElementById('cupsToAddInput').value);
      const productType = document.getElementById('cupsProductType').value;
      const name = currentCustomerToAddCups;

      if (isNaN(cupsToAdd) || cupsToAdd <= 0) {
        showToast('請輸入有效的杯數', 'danger');
        return;
      }

      const data = getData();
      if (!data[name]) data[name] = { count: 0, log: [], createdAt: new Date().toISOString() };
      
      data[name].productType = productType;
      data[name].count += cupsToAdd;
      const now = new Date();
      // 使用本地時間
      const timeStr = now.toLocaleString('zh-TW', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false,
        timeZone: 'Asia/Taipei'
      }).replace(/\//g, '/');
      data[name].log.push(`+${cupsToAdd} 杯 ${productType}（${timeStr}）`);
      
      saveData(data);
      showToast(`已為 ${name} 增加 ${cupsToAdd} 杯 ${productType}`);
      
      const modal = bootstrap.Modal.getInstance(document.getElementById('addMultipleCupsModal'));
      modal.hide();
      render();
    }

    // 商品類型管理相關函數
    function getProductTypes() {
      try {
        const item = localStorage.getItem('productTypes');
        // 如果 item 是 null, undefined 字串, 或空字串，則使用預設商品類型
        if (item === null || item === 'undefined' || item === '') {
            console.log('LocalStorage productTypes not found or invalid, using default types.');
            // 返回預設商品類型
            return ["鐵觀音", "烏龍茶", "紅茶", "綠茶", "其他"];
        }

        const productTypes = JSON.parse(item); // 嘗試解析讀取到的字串
         // 確保解析結果是陣列
        if (!Array.isArray(productTypes)) {
            console.error('productTypes in localStorage is not an array after parsing, using default types.');
             // 解析失敗也使用預設商品類型
            return ["鐵觀音", "烏龍茶", "紅茶", "綠茶", "其他"];
        }
        return productTypes;
      } catch (error) {
        console.error('讀取商品類型時發生錯誤：', error);
         // 發生解析錯誤時返回預設商品類型
        return ["鐵觀音", "烏龍茶", "紅茶", "綠茶", "其他"];
      }
    }

    function saveProductTypes(productTypes) {
      try {
        localStorage.setItem('productTypes', JSON.stringify(productTypes));
      } catch (error) {
        console.error('儲存商品類型時發生錯誤：', error);
      }
    }

    // 載入商品類型列表到設定 Modal
    function loadProductTypes() {
      const productTypeListElement = document.getElementById('productTypeList');
      if (!productTypeListElement) return; // 確保元素存在

      const productTypes = getProductTypes();
      productTypeListElement.innerHTML = ''; // 清空現有列表

      if (productTypes.length === 0) {
          // 如果 localStorage 沒有，顯示預設選項提示或直接載入預設？
          // 目前 getProductTypes 在沒有儲存時會返回預設，所以這裡理論上不會是空
          // 但為保險起見，可以加一個提示或載入預設 UI
      }

      productTypes.forEach(type => {
        const item = document.createElement('div');
        item.className = 'list-group-item d-flex justify-content-between align-items-center';
        item.innerHTML = `
          <span>${type}</span>
          <button type="button" class="btn btn-sm btn-danger" onclick="removeProductType('${escapeHtml(type)}')">移除</button>
        `;
        productTypeListElement.appendChild(item);
      });
       // 更新新增顧客 Modal 中的商品類型下拉選單
      updateProductTypeSelects();
    }

    // 新增商品類型
    function addProductType() {
      const newProductTypeInput = document.getElementById('newProductType');
      const newType = newProductTypeInput.value.trim();
      
      if (newType === '') {
        showToast('請輸入商品類型名稱', 'warning');
        return;
      }

      const productTypes = getProductTypes();
      if (productTypes.includes(newType)) {
        showToast('商品類型已存在', 'warning');
        return;
      }

      productTypes.push(newType);
      saveProductTypes(productTypes);
      showToast('商品類型新增成功');
      newProductTypeInput.value = '';
      loadProductTypes(); // 重新載入列表
    }

    // 移除商品類型
    function removeProductType(type) {
       // 先隱藏設定 Modal，確保確認視窗在最上層
      hideSettingsModal();

      const confirmModalElement = document.getElementById('confirmModal');
      const confirmMessageElement = document.getElementById('confirmMessage');
      const confirmActionBtn = document.getElementById('confirmActionBtn');

      confirmModalElement.querySelector('.modal-title').textContent = '確認移除商品類型';
      confirmMessageElement.innerHTML = `確定要移除商品類型 <strong>${escapeHtml(type)}</strong> 嗎？`;
      
      // 移除舊的事件監聽器
      const newConfirmActionBtn = confirmActionBtn.cloneNode(true);
      confirmActionBtn.parentNode.replaceChild(newConfirmActionBtn, confirmActionBtn);

      // 新增新的事件監聽器
      newConfirmActionBtn.addEventListener('click', () => {
        let productTypes = getProductTypes();
        productTypes = productTypes.filter(t => t !== type);
        saveProductTypes(productTypes);
        showToast('商品類型已移除');
        loadProductTypes(); // 重新載入列表
        bootstrap.Modal.getInstance(confirmModalElement).hide();
      });

      const confirmModal = new bootstrap.Modal(confirmModalElement);
      confirmModal.show();
    }

    // 更新新增顧客 Modal 中的商品類型下拉選單
    function updateProductTypeSelects() {
      const productTypeSelect = document.getElementById('newCustomerProductType');
      if (!productTypeSelect) return; // 確保元素存在
      
      const productTypes = getProductTypes();
      // 清空現有選項（保留第一個預設選項，或全部清空自行決定）
      productTypeSelect.innerHTML = '';

       // 加入預設選項（如果需要）
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = '請選擇商品類型';
      productTypeSelect.appendChild(defaultOption);

      productTypes.forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = type;
        productTypeSelect.appendChild(option);
      });
    }

    // HTML escaping 函數，防止 XSS 攻擊
    function escapeHtml(unsafe) {
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function editProductType(oldType) {
      const modal = new bootstrap.Modal(document.getElementById('editProductTypeModal'));
      document.getElementById('editProductTypeInput').value = oldType;
      document.getElementById('editProductTypeInput').dataset.oldType = oldType;
      modal.show();
    }

    function saveProductTypeEdit() {
      const input = document.getElementById('editProductTypeInput');
      const oldType = input.dataset.oldType;
      const newType = input.value.trim();

      if (!newType) {
        showToast('請輸入商品類型名稱', 'danger');
        return;
      }

      const types = getProductTypes();
      if (types.includes(newType) && newType !== oldType) {
        showToast('此商品類型已存在', 'danger');
        return;
      }

      // 更新商品類型列表
      const index = types.indexOf(oldType);
      types[index] = newType;
      saveProductTypes(types);

      // 更新所有顧客的商品類型
      const data = getData();
      Object.values(data).forEach(customer => {
        if (customer.productType === oldType) {
          customer.productType = newType;
        }
      });
      saveData(data);

      bootstrap.Modal.getInstance(document.getElementById('editProductTypeModal')).hide();
      showToast('商品類型更新成功');
      renderProductTypeList();
      updateProductTypeSelects();
      render(); // 重新渲染顧客列表
    }

    function deleteProductType(type) {
      if (!confirm(`確定要刪除商品類型「${type}」嗎？\n注意：此操作會將使用此商品類型的顧客改為「未指定」`)) {
        return;
      }

      const types = getProductTypes();
      const index = types.indexOf(type);
      if (index > -1) {
        types.splice(index, 1);
        saveProductTypes(types);

        // 更新所有使用此商品類型的顧客
        const data = getData();
        Object.values(data).forEach(customer => {
          if (customer.productType === type) {
            customer.productType = '未指定';
          }
        });
        saveData(data);

        showToast('商品類型已刪除');
        renderProductTypeList();
        updateProductTypeSelects();
        render(); // 重新渲染顧客列表
      }
    }

    function renderProductTypeList() {
      const list = document.getElementById('productTypeList');
      const types = getProductTypes();
      
      list.innerHTML = types.map(type => `
        <div class="list-group-item d-flex justify-content-between align-items-center">
          <span>${type}</span>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary" onclick="editProductType('${type}')">✏️</button>
            <button class="btn btn-outline-danger" onclick="deleteProductType('${type}')">🗑️</button>
          </div>
        </div>
      `).join('');
    }

    // 設定相關函數
    function showSettingsModal() {
      // 讀取當前設定值
      document.getElementById('autoBackupIntervalInput').value = localStorage.getItem('autoBackupInterval') || '1';
      document.getElementById('enablePredictiveSorting').checked = localStorage.getItem('predictiveSortingEnabled') === 'true';
      document.getElementById('enableDarkMode').checked = localStorage.getItem('darkModeEnabled') === 'true';
      document.getElementById('enableDailyReport').checked = localStorage.getItem('enableDailyReport') === 'true';
      document.getElementById('enableMonthlyReport').checked = localStorage.getItem('enableMonthlyReport') === 'true';

      // 渲染商品類型列表
      renderProductTypeList();

      const modal = new bootstrap.Modal(document.getElementById('settingsModal'));
      modal.show();
    }

    function saveAutoBackupSetting() {
      const inputElement = document.getElementById('autoBackupIntervalInput');
      const intervalHours = parseInt(inputElement.value);

      if (isNaN(intervalHours) || intervalHours < 1) {
        showToast('請輸入有效的備份間隔 (至少為 1 小時)', 'danger');
        inputElement.value = '1';
        return;
      }

      // 儲存所有設定
      localStorage.setItem('autoBackupInterval', intervalHours.toString());
      localStorage.setItem('predictiveSortingEnabled', document.getElementById('enablePredictiveSorting').checked.toString());
      localStorage.setItem('enableDarkMode', document.getElementById('enableDarkMode').checked.toString());

      // 更新深色模式
      applyDarkMode(document.getElementById('enableDarkMode').checked);

      // 更新自動備份計時器
      setAutoBackupInterval(intervalHours);

      showToast('設定已儲存');

      // 關閉 Modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('settingsModal'));
      modal.hide();

      // 重新渲染
      render();
    }

    // 深色模式相關函數
    function applyDarkMode(enabled) {
      if (enabled) {
        document.body.classList.add('dark-mode');
      } else {
        document.body.classList.remove('dark-mode');
      }
    }

    function setAutoBackupInterval(hours) {
      // 清除之前的計時器
      if (autoBackupIntervalId !== null) {
        clearInterval(autoBackupIntervalId);
    }

      // 設定新的計時器 (轉換為毫秒)
      const intervalMilliseconds = hours * 60 * 60 * 1000;
      autoBackupIntervalId = setInterval(autoBackup, intervalMilliseconds);
      console.log(`自動備份間隔已設定為每 ${hours} 小時。`);
    }

    // 自動備份
    function autoBackup() {
      // 不再直接調用 backup()，而是顯示 Modal
      const modal = new bootstrap.Modal(document.getElementById('autoBackupReadyModal'));
      modal.show();
      console.log('自動備份完成，提示用戶下載。');
    }

    // 觸發自動備份下載
    function triggerAutoBackupDownload() {
      // 調用現有的 backup 函數來執行下載
      backup();
      // 關閉 Modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('autoBackupReadyModal'));
      modal.hide();
    }

    // 新增報表相關函數
    function showDailyReport() {
      const today = new Date();
      // 使用本地時間
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      const formattedDate = `${year}-${month}-${day}`;
      document.getElementById('dailyReportDate').value = formattedDate;
      updateDailyReport();
      new bootstrap.Modal(document.getElementById('dailyReportModal')).show();
    }

    function showMonthlyReport() {
      const today = new Date();
      // 使用本地時間
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const yearMonth = `${year}-${month}`;
      document.getElementById('monthlyReportMonth').value = yearMonth;
      updateMonthlyReport();
      new bootstrap.Modal(document.getElementById('monthlyReportModal')).show();
    }

    function parseChineseDateTime(timeStr) {
      if (!timeStr) return new Date('invalid');
      
      // 嘗試解析標準格式 (YYYY/MM/DD HH:mm:ss)
      const standardMatch = timeStr.match(/(\d{4})\/(\d{1,2})\/(\d{1,2})\s+(\d{2}):(\d{2}):(\d{2})/);
      if (standardMatch) {
        const [_, year, month, day, hour, minute, second] = standardMatch;
        return new Date(year, month - 1, day, hour, minute, second);
      }
      
      // 嘗試解析中文格式 (YYYY年MM月DD日 HH:mm:ss)
      const chineseMatch = timeStr.match(/(\d{4})年(\d{1,2})月(\d{1,2})日\s+(\d{2}):(\d{2}):(\d{2})/);
      if (chineseMatch) {
        const [_, year, month, day, hour, minute, second] = chineseMatch;
        return new Date(year, month - 1, day, hour, minute, second);
      }
      
      // 嘗試標準的 Date 解析
      const date = new Date(timeStr);
      return isNaN(date.getTime()) ? new Date('invalid') : date;
    }

    function updateDailyReport() {
      const date = document.getElementById('dailyReportDate').value;
      const data = getData();
      const reportDate = new Date(date);
      
      // 收集當天的所有記錄
      const dailyRecords = [];
      Object.entries(data).forEach(([name, customer]) => {
        customer.log.forEach(log => {
          let logDate, count, isAdd, productType;
          
          try {
            if (typeof log === 'string') {
              const timeMatch = log.match(/（(.*?)）/);
              if (!timeMatch) return;
              
              const timeStr = timeMatch[1];
              logDate = parseChineseDateTime(timeStr);
              
              if (isNaN(logDate.getTime())) {
                console.warn('無法解析時間:', timeStr);
                return;
              }

              const countMatch = log.match(/([+-]\d+)/);
              if (!countMatch) return;
              
              isAdd = log.startsWith('+');
              count = Math.abs(parseInt(countMatch[1]));
              productType = log.includes('杯') ? log.split('杯')[1].trim().split('（')[0].trim() : '未指定';
            } else if (typeof log === 'object' && log !== null) {
              if (!log.timestamp) return;
              
              logDate = parseChineseDateTime(log.timestamp);
              if (isNaN(logDate.getTime())) {
                console.warn('無法解析時間戳記:', log.timestamp);
                return;
              }
              
              isAdd = log.type === 'add';
              count = Math.abs(log.count || 0);
              productType = log.productType || '未指定';
            } else {
              return;
            }

            // 檢查日期是否匹配
            if (logDate.toDateString() === reportDate.toDateString()) {
              dailyRecords.push({
                name,
                log: typeof log === 'string' ? log : `${isAdd ? '+' : '-'}${count} 杯 ${productType}（${log.timestamp}）`,
                productType,
                isAdd,
                count,
                timestamp: logDate
              });
            }
          } catch (error) {
            console.error('處理日誌記錄時出錯:', error, log);
          }
        });
      });

      // 生成報表內容
      let content = `
        <h6 class="mb-3">${reportDate.toLocaleDateString('zh-TW')} 營業報表</h6>
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>時間</th>
                <th>顧客</th>
                <th>商品類型</th>
                <th>操作</th>
                <th>數量</th>
              </tr>
            </thead>
            <tbody>
      `;

      // 按時間排序
      dailyRecords.sort((a, b) => a.timestamp - b.timestamp);

      let totalAdd = 0;
      let totalRemove = 0;

      dailyRecords.forEach(record => {
        const time = record.timestamp.toLocaleTimeString('zh-TW', { 
          hour: '2-digit', 
          minute: '2-digit',
          second: '2-digit',
          hour12: false 
        });
        content += `
          <tr>
            <td>${time}</td>
            <td>${record.name}</td>
            <td>${record.productType}</td>
            <td>${record.isAdd ? '加杯' : '扣杯'}</td>
            <td>${record.count}</td>
          </tr>
        `;
        if (record.isAdd) {
          totalAdd += record.count;
        } else {
          totalRemove += record.count;
        }
      });

      content += `
            </tbody>
            <tfoot>
              <tr class="table-info">
                <td colspan="3"><strong>當日統計</strong></td>
                <td>加杯總數</td>
                <td>${totalAdd}</td>
              </tr>
              <tr class="table-warning">
                <td colspan="3"></td>
                <td>扣杯總數</td>
                <td>${totalRemove}</td>
              </tr>
              <tr class="table-primary">
                <td colspan="3"></td>
                <td>淨增加</td>
                <td>${totalAdd - totalRemove}</td>
              </tr>
            </tfoot>
          </table>
        </div>
      `;

      document.getElementById('dailyReportContent').innerHTML = content;
    }

    function updateMonthlyReport() {
      const yearMonth = document.getElementById('monthlyReportMonth').value;
      const [year, month] = yearMonth.split('-').map(Number);
      const data = getData();
      
      // 收集該月的所有記錄
      const monthlyRecords = [];
      Object.entries(data).forEach(([name, customer]) => {
        customer.log.forEach(log => {
          let logDate, count, isAdd, productType;
          
          try {
            if (typeof log === 'string') {
              const timeMatch = log.match(/（(.*?)）/);
              if (!timeMatch) return;
              
              const timeStr = timeMatch[1];
              logDate = parseChineseDateTime(timeStr);
              
              if (isNaN(logDate.getTime())) {
                console.warn('無法解析時間:', timeStr);
                return;
              }

              const countMatch = log.match(/([+-]\d+)/);
              if (!countMatch) return;
              
              isAdd = log.startsWith('+');
              count = Math.abs(parseInt(countMatch[1]));
              productType = log.includes('杯') ? log.split('杯')[1].trim().split('（')[0].trim() : '未指定';
            } else if (typeof log === 'object' && log !== null) {
              if (!log.timestamp) return;
              
              logDate = parseChineseDateTime(log.timestamp);
              if (isNaN(logDate.getTime())) {
                console.warn('無法解析時間戳記:', log.timestamp);
                return;
              }
              
              isAdd = log.type === 'add';
              count = Math.abs(log.count || 0);
              productType = log.productType || '未指定';
            } else {
              return;
            }

            // 檢查日期是否在指定月份
            if (logDate.getFullYear() === year && logDate.getMonth() + 1 === month) {
              monthlyRecords.push({
                name,
                log: typeof log === 'string' ? log : `${isAdd ? '+' : '-'}${count} 杯 ${productType}（${log.timestamp}）`,
                productType,
                isAdd,
                count,
                date: logDate
              });
            }
          } catch (error) {
            console.error('處理日誌記錄時出錯:', error, log);
          }
        });
      });

      // 生成報表內容
      let content = `
        <h6 class="mb-3">${year}年${month}月營業報表</h6>
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>日期</th>
                <th>商品類型</th>
                <th>加杯數</th>
                <th>扣杯數</th>
                <th>淨增加</th>
              </tr>
            </thead>
            <tbody>
      `;

      // 按日期和商品類型分組統計
      const dailyStats = {};
      monthlyRecords.forEach(record => {
        const date = record.date.toLocaleDateString('zh-TW');
        if (!dailyStats[date]) {
          dailyStats[date] = {};
        }
        if (!dailyStats[date][record.productType]) {
          dailyStats[date][record.productType] = { add: 0, remove: 0 };
        }
        if (record.isAdd) {
          dailyStats[date][record.productType].add += record.count;
        } else {
          dailyStats[date][record.productType].remove += record.count;
        }
      });

      // 按日期排序
      const sortedDates = Object.keys(dailyStats).sort((a, b) => new Date(a) - new Date(b));
      
      let totalAdd = 0;
      let totalRemove = 0;
      const productTypeStats = {};

      sortedDates.forEach(date => {
        const productTypes = Object.keys(dailyStats[date]);
        productTypes.forEach(productType => {
          const stats = dailyStats[date][productType];
          const netChange = stats.add - stats.remove;
          
          if (!productTypeStats[productType]) {
            productTypeStats[productType] = { add: 0, remove: 0 };
          }
          productTypeStats[productType].add += stats.add;
          productTypeStats[productType].remove += stats.remove;

          content += `
            <tr>
              <td>${date}</td>
              <td>${productType}</td>
              <td>${stats.add}</td>
              <td>${stats.remove}</td>
              <td>${netChange}</td>
            </tr>
          `;

          totalAdd += stats.add;
          totalRemove += stats.remove;
        });
      });

      // 添加商品類型統計
      content += `
            </tbody>
            <tfoot>
              <tr class="table-info">
                <td colspan="2"><strong>商品類型統計</strong></td>
                <td colspan="3"></td>
              </tr>
      `;

      Object.entries(productTypeStats).forEach(([productType, stats]) => {
        const netChange = stats.add - stats.remove;
        content += `
          <tr class="table-light">
            <td colspan="2">${productType}</td>
            <td>${stats.add}</td>
            <td>${stats.remove}</td>
            <td>${netChange}</td>
          </tr>
        `;
      });

      content += `
              <tr class="table-primary">
                <td colspan="2"><strong>月結統計</strong></td>
                <td>${totalAdd}</td>
                <td>${totalRemove}</td>
                <td>${totalAdd - totalRemove}</td>
              </tr>
            </tfoot>
          </table>
        </div>
      `;

      document.getElementById('monthlyReportContent').innerHTML = content;
    }

    // 新增轉換舊資料格式的函數
    function convertOldDataFormat() {
      const data = getData();
      let hasChanges = false;

      Object.entries(data).forEach(([name, customer]) => {
        if (!customer.log) return;

        customer.log = customer.log.map(log => {
          if (typeof log !== 'string') return log;

          try {
            // 檢查是否包含上午/下午
            if (log.includes('上午') || log.includes('下午')) {
              hasChanges = true;
              const timeMatch = log.match(/（(.*?)）/);
              if (!timeMatch) return log;

              const oldTimeStr = timeMatch[1];
              console.log('處理時間字串:', oldTimeStr); // 調試信息

              const [datePart, timePart] = oldTimeStr.split(' ');
              if (!datePart || !timePart) {
                console.warn('無法分割日期和時間:', oldTimeStr);
                return log;
              }

              // 解析日期部分
              const [year, month, day] = datePart.split('/').map(num => parseInt(num, 10));
              if (isNaN(year) || isNaN(month) || isNaN(day)) {
                console.warn('日期解析失敗:', datePart);
                return log;
              }

              // 解析時間部分
              const [time, period] = timePart.split(' ');
              if (!time) {
                console.warn('無法解析時間部分:', timePart);
                return log;
              }

              let [hour, minute, second] = time.split(':').map(num => parseInt(num, 10));
              if (isNaN(hour) || isNaN(minute) || isNaN(second)) {
                console.warn('時間解析失敗:', time);
                return log;
              }

              // 轉換上午/下午為24小時制
              if (period === '下午' && hour !== 12) {
                hour += 12;
              } else if (period === '上午' && hour === 12) {
                hour = 0;
              }

              // 確保所有數字都是有效的
              if (isNaN(hour) || isNaN(minute) || isNaN(second)) {
                console.warn('轉換後時間無效:', { hour, minute, second });
                return log;
              }

              // 格式化新的時間字串
              const newTimeStr = `${year}/${String(month).padStart(2, '0')}/${String(day).padStart(2, '0')} ${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}:${String(second).padStart(2, '0')}`;
              console.log('轉換後時間:', newTimeStr); // 調試信息
              return log.replace(timeMatch[0], `（${newTimeStr}）`);
            }

            // 檢查是否為中文日期格式 (YYYY年MM月DD日)
            if (log.includes('年')) {
              hasChanges = true;
              const timeMatch = log.match(/（(.*?)）/);
              if (!timeMatch) return log;

              const oldTimeStr = timeMatch[1];
              console.log('處理中文時間字串:', oldTimeStr); // 調試信息

              const [datePart, timePart] = oldTimeStr.split(' ');
              if (!datePart || !timePart) {
                console.warn('無法分割中文日期和時間:', oldTimeStr);
                return log;
              }

              // 解析中文日期
              const year = parseInt(datePart.match(/(\d{4})年/)?.[1], 10);
              const month = parseInt(datePart.match(/(\d{1,2})月/)?.[1], 10);
              const day = parseInt(datePart.match(/(\d{1,2})日/)?.[1], 10);

              if (isNaN(year) || isNaN(month) || isNaN(day)) {
                console.warn('中文日期解析失敗:', datePart);
                return log;
              }

              // 解析時間部分
              let [hour, minute, second] = timePart.split(':').map(num => parseInt(num, 10));
              if (isNaN(hour) || isNaN(minute) || isNaN(second)) {
                console.warn('中文時間解析失敗:', timePart);
                return log;
              }

              // 格式化新的時間字串
              const newTimeStr = `${year}/${String(month).padStart(2, '0')}/${String(day).padStart(2, '0')} ${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}:${String(second).padStart(2, '0')}`;
              console.log('轉換後中文時間:', newTimeStr); // 調試信息
              return log.replace(timeMatch[0], `（${newTimeStr}）`);
            }

            // 檢查是否為標準格式但時間無效
            const timeMatch = log.match(/（(.*?)）/);
            if (timeMatch) {
              const timeStr = timeMatch[1];
              if (timeStr.includes('NaN')) {
                console.warn('發現無效時間格式:', timeStr);
                // 嘗試修復無效的時間
                const [datePart, timePart] = timeStr.split(' ');
                if (datePart && timePart) {
                  const [year, month, day] = datePart.split('/').map(num => parseInt(num, 10));
                  const [hour, minute, second] = timePart.split(':').map(num => {
                    const parsed = parseInt(num, 10);
                    return isNaN(parsed) ? 0 : parsed;
                  });
                  
                  if (!isNaN(year) && !isNaN(month) && !isNaN(day)) {
                    const newTimeStr = `${year}/${String(month).padStart(2, '0')}/${String(day).padStart(2, '0')} ${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}:${String(second).padStart(2, '0')}`;
                    console.log('修復無效時間:', newTimeStr);
                    hasChanges = true;
                    return log.replace(timeMatch[0], `（${newTimeStr}）`);
                  }
                }
              }
            }

            return log;
          } catch (error) {
            console.error('處理日誌時出錯:', error, log);
            return log;
          }
        });
      });

      if (hasChanges) {
        saveData(data);
        console.log('已將舊的資料格式轉換為24小時制');
      }
    }

    // 修改初始化部分
    document.addEventListener('DOMContentLoaded', () => {
      // 轉換舊的資料格式
      convertOldDataFormat();

      // 載入並應用深色模式設定
      const darkModeEnabled = localStorage.getItem('darkModeEnabled') === 'true';
      applyDarkMode(darkModeEnabled);

      // 載入並啟動自動備份
      const savedInterval = localStorage.getItem('autoBackupInterval') || '1';
      setAutoBackupInterval(parseInt(savedInterval));

      // 初始化商品類型選擇器
      updateProductTypeSelects();

      // 初始化時根據設定渲染
      render();
    });

    // 新增快速跳轉到今天的函數
    function showTodayReport() {
      const today = new Date();
      // 使用本地時間
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      const formattedDate = `${year}-${month}-${day}`;
      document.getElementById('dailyReportDate').value = formattedDate;
      updateDailyReport();
    }

    // 新增快速跳轉到當月的函數
    function showCurrentMonthReport() {
      const today = new Date();
      // 使用本地時間
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const yearMonth = `${year}-${month}`;
      document.getElementById('monthlyReportMonth').value = yearMonth;
      updateMonthlyReport();
    }

    // PWA: 註冊 service worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('./service-worker.js').then(function(registration) {
          console.log('ServiceWorker 註冊成功:', registration.scope);
        }, function(err) {
          console.log('ServiceWorker 註冊失敗:', err);
        });
      });
    }

    // 檢查更新相關函數
    let updateAvailable = false;
    let newVersion = '';
    let lastCheckTime = localStorage.getItem('lastUpdateCheck') || 0;
    const CHECK_INTERVAL = 1000 * 60 * 60; // 每小時檢查一次（可調整）
    let isCheckingForUpdates = false; // 新增旗標避免重複檢查

    // 更新最後檢查時間顯示
    function updateLastCheckTimeDisplay() {
      const lastCheck = localStorage.getItem('lastUpdateCheck');
      const lastCheckTimeElement = document.getElementById('lastCheckTime');
      if (lastCheck) {
        const date = new Date(parseInt(lastCheck));
        lastCheckTimeElement.textContent = date.toLocaleString();
      } else {
        lastCheckTimeElement.textContent = '尚未檢查';
      }
    }

    // 修改 checkForUpdates 函數，加入更新顯示時間
    async function checkForUpdates(silent = false) {
      // 如果正在檢查，則直接返回
      if (isCheckingForUpdates) {
        console.log('Already checking for updates.');
        if (!silent) showToast('正在檢查更新，請稍候...', 'info');
        return;
      }

      isCheckingForUpdates = true; // 設定為正在檢查

      try {
        const now = Date.now();
        const timeSinceLastCheck = now - lastCheckTime;

        // 對於非靜默檢查 (手動點擊)，只有在距離上次手動檢查超過一個較短時間（例如 10 秒）才執行，避免誤觸連點
        // 對於自動檢查 (靜默)，遵守 CHECK_INTERVAL
        const manualCheckInterval = 10000; // 手動檢查間隔 10 秒

        if (!silent && timeSinceLastCheck < manualCheckInterval) {
            console.log(`Manual check too soon (${timeSinceLastCheck}ms since last check). Minimum interval: ${manualCheckInterval}ms`);
            showToast(`請稍候再試。上次檢查於 ${Math.floor(timeSinceLastCheck / 1000)} 秒前。`, 'warning');
            isCheckingForUpdates = false;
            return;
        } else if (silent && timeSinceLastCheck < CHECK_INTERVAL) {
            console.log(`Silent check interval not met (${timeSinceLastCheck}ms since last check). Minimum interval: ${CHECK_INTERVAL}ms`);
            isCheckingForUpdates = false;
            return;
        }

        // 只有在非靜默模式下才顯示檢查中的提示
        if (!silent) {
            showToast('正在檢查更新...', 'info');
        }

        // 更新最後檢查時間（手動和自動檢查都會更新時間）
        lastCheckTime = now;
        localStorage.setItem('lastUpdateCheck', now);
        updateLastCheckTimeDisplay(); // Update display immediately after setting new time
        
        // 獲取 manifest.json
        // 加入時間戳避免瀏覽器快取
        const response = await fetch('./manifest.json?t=' + now);
        if (!response.ok) {
            // 如果 manifest.json 無法訪問 (例如 404)，不視為更新錯誤，可能是 PWA 安裝在非根目錄
            console.warn(`Failed to fetch manifest.json: status ${response.status}`);
            if (!silent && response.status !== 404) {
                 showToast(`檢查更新失敗：無法獲取 manifest.json (狀態碼: ${response.status})`, 'danger');
            }
             isCheckingForUpdates = false;
            return; // 無法獲取 manifest，結束檢查
        }
        const manifest = await response.json();
        
        // 獲取當前版本
        const currentVersionElement = document.getElementById('currentVersion');
        const currentVersion = currentVersionElement ? currentVersionElement.textContent : '-';

        console.log(`Current version: ${currentVersion}, Manifest version: ${manifest.version}`); // Debug line
        
        // 比較版本
        if (manifest.version && manifest.version !== currentVersion) {
          updateAvailable = true;
          newVersion = manifest.version;
          
          // 更新版本號顯示在 Modal 中
          const currentVersionModalElement = document.getElementById('currentVersionModal');
          const newVersionModalElement = document.getElementById('newVersionModal');
          if (currentVersionModalElement) currentVersionModalElement.textContent = currentVersion;
          if (newVersionModalElement) newVersionModalElement.textContent = newVersion;

          // 更新當前版本號顯示
          if (currentVersionElement) {
            currentVersionElement.textContent = manifest.version;
          }

          // 顯示更新提示 Modal
          const updateModal = new bootstrap.Modal(document.getElementById('updateModal'));
          updateModal.show();

          // 儲存新版本號到 localStorage
          localStorage.setItem('appVersion', manifest.version);

        } else if (!silent) {
          showToast('您目前使用的是最新版本！');
        } else {
             console.log('Auto check: already on latest version.'); // Debug line for silent checks
        }
      } catch (error) {
        console.error('檢查更新時發生錯誤：', error);
        if (!silent) {
          showToast('檢查更新時發生錯誤，請稍後再試。', 'danger');
        }
      } finally {
          isCheckingForUpdates = false; // 檢查結束
      }
    }

    // 自動檢查更新
    function startAutoUpdateCheck() {
      // 頁面載入時檢查一次
      checkForUpdates(true);
      
      // 設定定期檢查
      setInterval(() => {
        checkForUpdates(true);
      }, CHECK_INTERVAL);
      
      // 當頁面重新獲得焦點時檢查
      window.addEventListener('focus', () => {
        checkForUpdates(true);
      });
    }

    // 在 Service Worker 註冊時啟動自動檢查
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          const registration = await navigator.serviceWorker.register('./service-worker.js');
          
          // 啟動自動檢查更新
          startAutoUpdateCheck();
          
          // 監聽 Service Worker 更新
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                // 有新的 Service Worker 可用
                updateAvailable = true;
                // 顯示更新通知
                if (confirm('發現新版本！是否要更新？')) {
                  window.location.reload();
                }
              }
            });
          });
        } catch (error) {
          console.error('Service Worker 註冊失敗：', error);
        }
      });
    }

    // 在頁面載入時更新顯示時間（確保顯示正確的上次檢查時間）
    window.addEventListener('load', () => {
      updateLastCheckTimeDisplay();
    });

    // 儲存設定函數 (需要您根據實際的設定項目來實現)
    function saveSettings() {
      try {
        const autoBackupInterval = document.getElementById('autoBackupIntervalInput').value;
        const enablePredictiveSorting = document.getElementById('enablePredictiveSorting').checked;
        const enableDarkMode = document.getElementById('enableDarkMode').checked;
        const enableDailyReport = document.getElementById('enableDailyReport').checked;
        const enableMonthlyReport = document.getElementById('enableMonthlyReport').checked;

        localStorage.setItem('autoBackupInterval', autoBackupInterval);
        localStorage.setItem('enablePredictiveSorting', enablePredictiveSorting);
        localStorage.setItem('enableDarkMode', enableDarkMode);
        localStorage.setItem('enableDailyReport', enableDailyReport);
        localStorage.setItem('enableMonthlyReport', enableMonthlyReport);

        // 您可能還需要儲存商品類型列表
        // ... 儲存商品類型列表的邏輯 ...
        // 這裡需要調用一個函數來獲取並儲存商品類型列表
        saveProductTypes(); // 假設您有一個 saveProductTypes 函數來處理商品類型的儲存

        showToast('設定已儲存！');
        // 儲存後關閉 Modal
        const settingsModal = bootstrap.Modal.getInstance(document.getElementById('settingsModal'));
        if (settingsModal) {
          settingsModal.hide();
        }

         // 應用深色模式設定
        if (enableDarkMode) {
            document.body.classList.add('dark-mode');
        } else {
            document.body.classList.remove('dark-mode');
        }

      } catch (error) {
        console.error('儲存設定時發生錯誤：', error);
        showToast('儲存設定時發生錯誤，請稍後再試。', 'danger');
      }
    }

    // 在 Modal 載入時讀取設定 (需要您根據實際的設定項目來實現)
    document.getElementById('settingsModal').addEventListener('show.bs.modal', function () {
      try {
        const autoBackupInterval = localStorage.getItem('autoBackupInterval') || '1';
        const enablePredictiveSorting = localStorage.getItem('enablePredictiveSorting') === 'true';
        const enableDarkMode = localStorage.getItem('enableDarkMode') === 'true';
        const enableDailyReport = localStorage.getItem('enableDailyReport') === 'true';
        const enableMonthlyReport = localStorage.getItem('enableMonthlyReport') === 'true';

        document.getElementById('autoBackupIntervalInput').value = autoBackupInterval;
        document.getElementById('enablePredictiveSorting').checked = enablePredictiveSorting;
        document.getElementById('enableDarkMode').checked = enableDarkMode;
        document.getElementById('enableDailyReport').checked = enableDailyReport;
        document.getElementById('enableMonthlyReport').checked = enableMonthlyReport;

        // 載入商品類型列表
         loadProductTypes();

         // 應用深色模式設定
        if (enableDarkMode) {
            document.body.classList.add('dark-mode');
        } else {
            document.body.classList.remove('dark-mode');
        }

      } catch (error) {
        console.error('載入設定時發生錯誤：', error);
        showToast('載入設定時發生錯誤，請稍後再試。', 'danger');
      }
    });

    // 在頁面載入時應用深色模式設定並更新商品類型下拉選單
    window.addEventListener('load', () => {
      const enableDarkMode = localStorage.getItem('enableDarkMode') === 'true';
      if (enableDarkMode) {
        document.body.classList.add('dark-mode');
      }
      updateLastCheckTimeDisplay(); // 保證上次檢查時間顯示正確
      updateProductTypeSelects(); // 頁面載入時更新商品類型下拉選單
    });

    // 隱藏設定 Modal 的函數
    function hideSettingsModal() {
      const settingsModal = bootstrap.Modal.getInstance(document.getElementById('settingsModal'));
      if (settingsModal) {
        settingsModal.hide();
      }
    }

    // Service Worker 註冊及更新處理
    let newServiceWorker = null;

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          const registration = await navigator.serviceWorker.register('./service-worker.js');

          console.log('Service Worker 註冊成功：', registration);

          // 監聽 Service Worker 更新
          registration.addEventListener('updatefound', () => {
            console.log('Service Worker updatefound event detected.');
            newServiceWorker = registration.installing;

            newServiceWorker.addEventListener('statechange', () => {
              console.log('Service Worker state changed:', newServiceWorker.state);
              if (newServiceWorker.state === 'installed' && navigator.serviceWorker.controller) {
                // 有新的 Service Worker 安裝完成並在等待中
                console.log('New Service Worker installed and waiting.');
                
                // 嘗試獲取新版本號並顯示 Modal
                // ... existing code to fetch manifest and show modal ...

                 // 顯示更新提示 Modal
                const updateModalElement = document.getElementById('updateModal');
                if (updateModalElement) {
                     const updateModal = new bootstrap.Modal(updateModalElement);
                     updateModal.show();
                } else {
                    console.error('Update modal element not found.');
                }
              }
            });
          });

          // 檢查是否有等待中的更新（使用者之前關閉了應用程式）
          if (registration.waiting) {
              newServiceWorker = registration.waiting;
              console.log('Found waiting Service Worker from previous session.', newServiceWorker);
               // 顯示更新提示 Modal
               // ... existing code to fetch manifest and show modal ...

              const updateModalElement = document.getElementById('updateModal');
                if (updateModalElement) {
                     const updateModal = new bootstrap.Modal(updateModalElement);
                     updateModal.show();
                } else {
                    console.error('Update modal element not found.');
                }
          }

           // 啟動自動檢查更新（可以保留，它用於設定中的手動檢查和定時檢查，但 Service Worker 本身也會檢查）
           startAutoUpdateCheck(); // 根據需求決定是否保留，保留的話可以更快偵測到 manifest 的變化

        } catch (error) {
          console.error('Service Worker 註冊失敗：', error);
          // 如果 Service Worker 註冊失敗，影響 PWA 功能，可以考慮提示用戶或記錄日誌
        }
      });

      // 監聽 Service Worker 控制權變化（表示新的 Service Worker 已經啟用）
      navigator.serviceWorker.addEventListener('controllerchange', () => {
          console.log('Controller changed, new Service Worker is active. Reloading page...');
           // 重新載入頁面以使用新的 Service Worker 控制的檔案
          window.location.reload();
      });

    }

    // 應用更新（使用者點擊提示按鈕時觸發）
    function applyUpdate() {
        console.log('applyUpdate called.');
        
        // 顯示加載動畫
        const updateLoading = document.getElementById('updateLoading');
        updateLoading.classList.add('show');
        
        // 隱藏 Modal
        const updateModalElement = document.getElementById('updateModal');
        const updateModal = bootstrap.Modal.getInstance(updateModalElement);
        if (updateModal) {
            console.log('Hiding update modal.');
            updateModal.hide();
        } else {
            console.log('Update modal instance not found.');
        }

        // 延遲執行更新操作，讓用戶看到加載動畫
        setTimeout(() => {
            // 強制清除快取並重新載入
            if ('caches' in window) {
                caches.keys().then(function(names) {
                    for (let name of names) {
                        caches.delete(name);
                    }
                });
            }

            if (newServiceWorker) {
                console.log('Sending SKIP_WAITING message to newServiceWorker:', newServiceWorker);
                // 通知 Service Worker 跳過等待
                newServiceWorker.postMessage({ type: 'SKIP_WAITING' });
                
                // 監聽 Service Worker 的狀態變化
                newServiceWorker.addEventListener('statechange', () => {
                    if (newServiceWorker.state === 'activated') {
                        console.log('Service Worker activated, updating version number...');
                        // 只有在 Service Worker 完全啟動後才更新版本號
                        const newVersion = document.getElementById('newVersionModal').textContent;
                        localStorage.setItem('appVersion', newVersion);
                        const currentVersionElement = document.getElementById('currentVersion');
                        if (currentVersionElement) {
                            currentVersionElement.textContent = newVersion;
                        }
                        // 強制重新載入頁面
                        window.location.reload(true);
                    }
                });
            } else {
                // 如果沒有新的 Service Worker，直接重新載入
                window.location.reload(true);
            }
        }, 1500); // 延遲 1.5 秒，讓用戶能看到加載動畫
    }

    // 在頁面載入時檢查版本號
    window.addEventListener('load', () => {
        const savedVersion = localStorage.getItem('appVersion');
        const currentVersionElement = document.getElementById('currentVersion');
        if (savedVersion && currentVersionElement) {
            currentVersionElement.textContent = savedVersion;
        }
    });
  </script>
</body>
</html>
