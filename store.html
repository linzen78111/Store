<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å¯„æ¯ç®¡ç†å°å·¥å…· - OPENPOINTé¢¨æ ¼</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0078d4">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    /* å­—é«”èˆ‡èƒŒæ™¯ */
  body {
    font-family: "Noto Sans TC", sans-serif;
    background: linear-gradient(270deg, #ff9a9e, #fad0c4, #fad0c4, #a18cd1, #fbc2eb);
    background-size: 1000% 1000%;
    animation: gradientShift 30s ease infinite;
    transition: background 0.5s ease;
      color: #333;
      /* ä½¿ç”¨ Flexbox ä½ˆå±€ */
      display: flex;
      flex-direction: column;
  }

  /* æ›´æ–°åŠ è¼‰å‹•ç•« */
  .update-loading {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 2000;
    justify-content: center;
    align-items: center;
    flex-direction: column;
  }

  .update-loading.show {
    display: flex;
    animation: fadeIn 0.3s ease-in-out;
  }

  .update-loading-spinner {
    width: 80px;
    height: 80px;
    position: relative;
    margin-bottom: 20px;
  }

  .update-loading-spinner::before,
  .update-loading-spinner::after {
    content: '';
    position: absolute;
    border-radius: 50%;
    animation: updateSpinner 1.5s linear infinite;
  }

  .update-loading-spinner::before {
    width: 100%;
    height: 100%;
    border: 4px solid transparent;
    border-top-color: #0078d4;
    border-right-color: #0078d4;
    animation-delay: -0.5s;
  }

  .update-loading-spinner::after {
    width: 70%;
    height: 70%;
    top: 15%;
    left: 15%;
    border: 4px solid transparent;
    border-top-color: #fad0c4;
    border-right-color: #fad0c4;
  }

  .update-loading-text {
    color: white;
    font-size: 1.2rem;
    text-align: center;
    margin-top: 20px;
    animation: updateTextPulse 1.5s ease-in-out infinite;
  }

  .update-loading-progress {
    width: 200px;
    height: 4px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 2px;
    margin-top: 15px;
    overflow: hidden;
  }

  .update-loading-progress-bar {
    width: 0%;
    height: 100%;
    background: #0078d4;
    animation: updateProgress 2s ease-in-out infinite;
  }

  @keyframes updateSpinner {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }

  @keyframes updateTextPulse {
    0%, 100% {
      opacity: 1;
    }
    50% {
      opacity: 0.7;
    }
  }

  @keyframes updateProgress {
    0% {
      width: 0%;
    }
    50% {
      width: 100%;
    }
    100% {
      width: 100%;
    }
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  /* æ›´æ–° Modal å‹•ç•«æ•ˆæœ */
  #updateModal .modal-dialog {
    transform: scale(0.7);
    opacity: 0;
    transition: all 0.3s ease-in-out;
  }

  #updateModal.show .modal-dialog {
    transform: scale(1);
    opacity: 1;
  }

  /* æ›´æ–°æŒ‰éˆ•å‹•ç•« */
  #updateModal .btn-primary {
    position: relative;
    overflow: hidden;
  }

  #updateModal .btn-primary::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 5px;
    height: 5px;
    background: rgba(255, 255, 255, 0.5);
    opacity: 0;
    border-radius: 100%;
    transform: scale(1, 1) translate(-50%);
    transform-origin: 50% 50%;
  }

  #updateModal .btn-primary:focus:not(:active)::after {
    animation: ripple 1s ease-out;
  }

  @keyframes ripple {
    0% {
      transform: scale(0, 0);
      opacity: 0.5;
    }
    100% {
      transform: scale(20, 20);
      opacity: 0;
    }
  }

  /* ç‰ˆæœ¬è™Ÿæ›´æ–°å‹•ç•« */
  #updateModal .version-update {
    animation: versionPulse 2s infinite;
  }

  @keyframes versionPulse {
    0% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.05);
    }
    100% {
      transform: scale(1);
    }
  }

  /* ç¢ºä¿æ›´æ–° Modal é¡¯ç¤ºåœ¨æœ€ä¸Šå±¤ */
  #updateModal {
    z-index: 1060 !important;
  }

  @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* å¡ç‰‡ */
    .card {
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .card:hover {
      transform: scale(1.03);
      box-shadow: 0 8px 20px rgba(0, 123, 255, 0.25);
    }

    /* æ¨™é¡Œ */
    h1 {
      color: #1f3b73; /* æ·±è— */
      font-weight: 700;
    }

    /* OPENPOINT ä¸»è‰²èª¿æŒ‰éˆ• */
    .btn-primary {
      background-color: #0078d4;
      border-color: #0078d4;
      font-weight: 600;
      border-radius: 12px;
      transition: background-color 0.3s ease;
    }
    .btn-primary:hover {
      background-color: #005a9e;
      border-color: #005a9e;
    }

    /* å…¶ä»–æŒ‰éˆ•è‰²å½©èª¿æ•´ */
    .btn-success {
      background-color: #28a745;
      border-radius: 12px;
      font-weight: 600;
    }
    .btn-success:hover {
      background-color: #1e7e34;
    }
    .btn-warning {
      background-color: #ffc107;
      border-radius: 12px;
      font-weight: 600;
      color: #212529;
    }
    .btn-warning:hover {
      background-color: #e0a800;
      color: #212529;
    }
    .btn-info {
      background-color: #17a2b8;
      border-radius: 12px;
      font-weight: 600;
    }
    .btn-info:hover {
      background-color: #117a8b;
    }
    .btn-secondary {
      border-radius: 12px;
      font-weight: 600;
    }

    /* è­¦ç¤ºå¾½ç« ï¼šä½æ¯æ•¸ç´…æ¨™ */
    .badge-low {
      background-color: #dc3545 !important; /* ç´…è‰² */
      color: white;
      font-weight: 700;
      box-shadow: 0 0 5px rgba(220, 53, 69, 0.7);
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 5px rgba(220, 53, 69, 0.7); }
      50% { box-shadow: 0 0 15px rgba(220, 53, 69, 1); }
    }

    /* æœå°‹æ¬„é™°å½± */
    #searchInput {
      border-radius: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    /* æ‰‹æ©Ÿå‹å–„é–“è· */
    .btn-group {
      gap: 10px;
      flex-wrap: wrap;
    }

    /* æ–°å¢æ¨£å¼ */
    .toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1050;
    }

    .customer-card {
      transition: all 0.3s ease;
    }

    .customer-card:hover {
      transform: translateY(-2px);
    }

    .stats-badge {
      font-size: 0.8rem;
      padding: 0.25rem 0.5rem;
      margin-left: 0.5rem;
    }

    .note-badge {
      background-color: #6c757d;
      color: white;
      font-size: 0.8rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      margin-left: 0.5rem;
      cursor: pointer;
    }

    .note-badge:hover {
      background-color: #5a6268;
    }

    @media (max-width: 576px) {
      .btn-group {
        flex-direction: column;
        width: 100%;
      }
      .btn-group .btn {
        width: 100%;
        margin: 2px 0;
        padding: .25rem .5rem;
        font-size: .875rem;
      }
      .customer-card .d-flex {
        flex-direction: column;
        align-items: stretch !important;
      }
      .customer-card .btn-group {
        margin-top: 10px;
      }
      .customer-card .d-flex > div:last-child {
        gap: 5px !important;
      }
    }

    /* é€²ä¸€æ­¥ç¸®å°é¡§å®¢å¡ç‰‡å…§çš„æŒ‰éˆ• */
    .customer-card .btn-group .btn,
    .customer-card .btn-outline-info.btn-sm,
    .customer-card .btn-outline-danger.btn-sm {
      padding: .2rem .4rem; /* ç¨å¾®ç¸®å°å…§è· */
      font-size: .8rem; /* ç¸®å°å­—é«” */
      border-radius: 8px; /* èª¿æ•´åœ“è§’ */
    }

    .customer-card .d-flex > div:last-child {
      gap: 8px; /* èª¿æ•´æŒ‰éˆ•ä¹‹é–“çš„é–“è· */
    }

    /* æ–°å¢æ¨£å¼ä»¥èª¿æ•´å¡ç‰‡å…§éƒ¨çµæ§‹é–“è· */
    .customer-card > div:first-child {
        margin-bottom: 10px; /* å¢åŠ åç¨±/å‚™è¨»å€åŸŸå’ŒæŒ‰éˆ•å€åŸŸä¹‹é–“çš„é–“è· */
    }

    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
    }

    .container {
        flex-grow: 1; /* è®“å®¹å™¨ä½”æ“šå‰©é¤˜ç©ºé–“ */
        display: flex; /* ä½¿ç”¨ Flexbox ä½ˆå±€å…§éƒ¨å…§å®¹ */
        flex-direction: column;
        padding-top: 1.5rem !important; /* æ¢å¾©é ‚éƒ¨å…§è· */
        padding-bottom: 1.5rem !important; /* æ¢å¾©åº•éƒ¨å…§è· */
        overflow: hidden; /* é˜²æ­¢å…§å®¹æº¢å‡ºå®¹å™¨å°è‡´æ•´é«”æ»¾å‹• */
    }

    .main-content {
        flex-grow: 1; /* è®“ä¸»è¦å…§å®¹å€å¡Šä½”æ“šå‰©é¤˜ç©ºé–“ */
        overflow-y: auto; /* å‚ç›´æ–¹å‘å¯æ»¾å‹• */
        padding-top: 1rem; /* ç‚ºä¸»è¦å…§å®¹å€å¡Šæ·»åŠ é ‚éƒ¨å…§è· */
    }

    /* æ·±è‰²æ¨¡å¼ */
    .dark-mode {
      background: linear-gradient(270deg, #2c3e50, #34495e, #2c3e50, #1a252f, #1a252f); /* æ›´æ·±çš„æ¼¸è®ŠèƒŒæ™¯ */
      color: #ecf0f1; /* æ·ºç°æ–‡å­— */
    }

    .dark-mode h1 {
      color: #bdc3c7; /* è¼ƒæ·ºçš„æ¨™é¡Œé¡è‰² */
    }

    .dark-mode .card {
      background-color: #34495e; /* æ·±è—èƒŒæ™¯ */
      color: #ecf0f1; /* æ·ºç°æ–‡å­— */
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); /* èª¿æ•´é™°å½± */
    }

    .dark-mode .card:hover {
       box-shadow: 0 8px 20px rgba(0, 123, 255, 0.1); /* èª¿æ•´é™°å½± */
    }

    .dark-mode .badge-low {
      background-color: #e74c3c !important; /* èª¿æ•´ç´…è‰² */
    }

    .dark-mode .bg-primary {
       background-color: #3498db !important; /* èª¿æ•´è—è‰² */
    }

    .dark-mode .btn-primary {
        background-color: #3498db; /* èª¿æ•´æŒ‰éˆ•è—è‰² */
        border-color: #3498db;
    }
    .dark-mode .btn-primary:hover {
        background-color: #2980b9; /* èª¿æ•´ hover è—è‰² */
        border-color: #2980b9;
    }

     .dark-mode .btn-success {
      background-color: #2ecc71; /* èª¿æ•´æŒ‰éˆ•ç¶ è‰² */
      border-color: #2ecc71;
    }
    .dark-mode .btn-success:hover {
      background-color: #27ae60; /* èª¿æ•´ hover ç¶ è‰² */
      border-color: #27ae60;
    }

     .dark-mode .btn-secondary {
        background-color: #7f8c8d; /* èª¿æ•´æŒ‰éˆ•ç°è‰² */
        border-color: #7f8c8d;
        color: #ecf0f1; /* æ·ºç°æ–‡å­— */
    }
     .dark-mode .btn-secondary:hover {
        background-color: #95a5a6; /* èª¿æ•´ hover ç°è‰² */
        border-color: #95a5a6;
    }

    .dark-mode .btn-warning {
      background-color: #f1c40f; /* èª¿æ•´æŒ‰éˆ•é»ƒè‰² */
      border-color: #f1c40f;
      color: #333; /* æ·±è‰²æ–‡å­— */
    }
    .dark-mode .btn-warning:hover {
      background-color: #f39c12; /* èª¿æ•´ hover é»ƒè‰² */
      border-color: #f39c12;
    }

    .dark-mode .btn-info {
      background-color: #3498db; /* èª¿æ•´æŒ‰éˆ•æ·ºè— */
      border-color: #3498db;
    }
     .dark-mode .btn-info:hover {
      background-color: #2980b9; /* èª¿æ•´ hover æ·ºè— */
      border-color: #2980b9;
    }

     .dark-mode .btn-outline-info {
      color: #3498db; /* èª¿æ•´å¤–æ¡†æŒ‰éˆ•é¡è‰² */
      border-color: #3498db;
    }
     .dark-mode .btn-outline-info:hover {
       color: #ecf0f1; /* èª¿æ•´å¤–æ¡†æŒ‰éˆ• hover é¡è‰² */
       background-color: #3498db;
       border-color: #3498db;
    }

    .dark-mode .btn-outline-danger {
       color: #e74c3c; /* èª¿æ•´å¤–æ¡†æŒ‰éˆ•é¡è‰² */
       border-color: #e74c3c;
    }
     .dark-mode .btn-outline-danger:hover {
        color: #ecf0f1; /* èª¿æ•´å¤–æ¡†æŒ‰éˆ• hover é¡è‰² */
        background-color: #e74c3c;
        border-color: #e74c3c;
    }

    .dark-mode #searchInput {
        background-color: #2c3e50; /* æ·±è‰²èƒŒæ™¯ */
        color: #ecf0f1; /* æ·ºç°æ–‡å­— */
        box-shadow: 0 2px 6px rgba(0,0,0,0.2); /* èª¿æ•´é™°å½± */
        border-color: #34495e; /* èª¿æ•´é‚Šæ¡†é¡è‰² */
    }

    .dark-mode .alert-info {
        background-color: #3498db;
        color: #ecf0f1;
        border-color: #2980b9;
    }

     .dark-mode .alert-success {
        background-color: #2ecc71;
        color: #ecf0f1;
        border-color: #27ae60;
    }

     .dark-mode .alert-danger {
        background-color: #e74c3c;
        color: #ecf0f1;
        border-color: #c0392b;
    }

    .dark-mode .modal-content {
        background-color: #2c3e50; /* æ·±è‰²èƒŒæ™¯ */
        color: #ecf0f1; /* æ·ºç°æ–‡å­— */
    }

    .dark-mode .modal-header {
        border-color: #34495e; /* èª¿æ•´é‚Šæ¡†é¡è‰² */
    }

     .dark-mode .modal-footer {
        border-color: #34495e; /* èª¿æ•´é‚Šæ¡†é¡è‰² */
    }

    .dark-mode .list-group-item {
        background-color: #34495e; /* æ·±è‰²èƒŒæ™¯ */
        color: #ecf0f1; /* æ·ºç°æ–‡å­— */
        border-color: rgba(255, 255, 255, 0.1); /* èª¿æ•´é‚Šæ¡†é¡è‰² */
    }

    .dark-mode .list-group-item-action:hover {
        background-color: #2c3e50; /* æ·±è‰² hover èƒŒæ™¯ */
    }

    .dark-mode .form-label {
        color: #bdc3c7; /* èª¿æ•´æ¨™ç±¤é¡è‰² */
    }

    .dark-mode .form-control {
        background-color: #34495e; /* æ·±è‰²èƒŒæ™¯ */
        color: #ecf0f1; /* æ·ºç°æ–‡å­— */
        border-color: #34495e; /* èª¿æ•´é‚Šæ¡†é¡è‰² */
    }

    .dark-mode .form-control::placeholder {
        color: #bdc3c7; /* èª¿æ•´ placeholder é¡è‰² */
        opacity: 0.7; /* èª¿æ•´é€æ˜åº¦ */
    }

    .dark-mode .text-muted {
        color: #bdc3c7 !important; /* èª¿æ•´éœé»˜æ–‡å­—é¡è‰² */
    }

    .dark-mode .toast-body {
       color: #ecf0f1; /* æ·ºç°æ–‡å­— */
    }

    .dark-mode .note-badge {
       background-color: #5a6268; /* èª¿æ•´å‚™è¨»å¾½ç« é¡è‰² */
    }
     .dark-mode .note-badge:hover {
        background-color: #6c757d; /* èª¿æ•´å‚™è¨»å¾½ç«  hover é¡è‰² */
    }
  </style>
</head>
<body class="container py-4">
  <!-- æ›´æ–°åŠ è¼‰å‹•ç•« -->
  <div class="update-loading" id="updateLoading">
    <div class="update-loading-spinner"></div>
    <div class="update-loading-text">æ­£åœ¨æ›´æ–°æ‡‰ç”¨ç¨‹å¼...</div>
    <div class="update-loading-progress">
      <div class="update-loading-progress-bar"></div>
    </div>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">â˜• å¯„æ¯ç®¡ç†å°å·¥å…·</h1>
    <div class="mt-2 mt-sm-0">
      <button class="btn btn-sm btn-outline-primary" onclick="showQuickSearch()">ğŸ” å¿«é€Ÿæœå°‹</button>
    </div>
  </div>

  <!-- çµ±è¨ˆè³‡è¨Š -->
  <div class="alert alert-info mb-3" role="alert">
    <div class="d-flex justify-content-between align-items-center flex-wrap">
      <div>
        <span class="badge bg-primary me-2">ç¸½é¡§å®¢æ•¸ï¼š<span id="totalCustomers">0</span></span>
        <span class="badge bg-success me-2">ç¸½æ¯æ•¸ï¼š<span id="totalCups">0</span></span>
        <span class="badge bg-warning text-dark">æœ€å¾Œæ›´æ–°ï¼š<span id="lastUpdate">-</span></span>
      </div>
    </div>
  </div>

  <!-- å°‡æœå°‹ã€æŒ‰éˆ•å’Œåˆ—è¡¨åŒ…è£åœ¨ä¸€å€‹æ–°çš„ div ä¸­ -->
  <div class="main-content">
  <!-- æœå°‹æ¬„ä½ -->
  <div class="mb-3">
    <input id="searchInput" class="form-control" placeholder="ğŸ” æœå°‹é¡§å®¢åç¨±" oninput="render()" />
  </div>

  <!-- æŒ‰éˆ•åˆ— -->
  <div class="mb-3 d-flex flex-wrap gap-2 btn-group">
    <button class="btn btn-info" onclick="backup()">ğŸ’¾ æ‰‹å‹•å‚™ä»½</button>
    <input type="file" id="importInput" accept=".json" style="display:none" onchange="importBackup(event)" />
    <button class="btn btn-warning" onclick="document.getElementById('importInput').click()">ğŸ“¥ åŒ¯å…¥å‚™ä»½</button>
    <button class="btn btn-secondary" type="button" data-bs-toggle="modal" data-bs-target="#settingsModal">
      âš™ï¸ è¨­å®š
    </button>
  </div>

  <!-- é¡§å®¢åˆ—è¡¨ -->
  <div id="customerList" class="vstack gap-3"></div>
  </div>

  <!-- Toast æç¤ºå®¹å™¨ -->
  <div class="toast-container"></div>

  <!-- æ–°å¢è‡ªè¨‚çš„æ›´æ–°æç¤º Modal -->
  <div id="updateModal" class="modal fade" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4 shadow-sm">
        <div class="modal-header">
          <h5 class="modal-title" id="updateModalLabel">
            <span class="version-update">âœ¨</span> æ–°ç‰ˆæœ¬å¯ç”¨ï¼
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="version-update">ç™¼ç¾æ–°çš„æ‡‰ç”¨ç¨‹å¼ç‰ˆæœ¬ï¼Œå»ºè­°ç«‹å³æ›´æ–°ä»¥å–å¾—æœ€æ–°åŠŸèƒ½åŠä¿®æ­£ã€‚</p>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <p class="mb-0">ç›®å‰ç‰ˆæœ¬ï¼š<span id="currentVersionModal" class="badge bg-secondary">1.0.0</span></p>
            <span class="version-update">â†’</span>
            <p class="mb-0">æ–°ç‰ˆæœ¬ï¼š<span id="newVersionModal" class="badge bg-primary">-</span></p>
          </div>
          <small class="text-muted d-block">ï¼ˆæ›´æ–°éœ€è¦é‡æ–°è¼‰å…¥é é¢ï¼‰</small>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ç¨å¾Œå†èªª</button>
          <button type="button" class="btn btn-primary version-update" onclick="applyUpdate()">
            <span class="me-1">ğŸ”„</span>ç«‹å³æ›´æ–°
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- è‡ªå‹•å‚™ä»½å·²å®Œæˆ Modal -->
  <div id="autoBackupReadyModal" class="modal fade" tabindex="-1" aria-labelledby="autoBackupReadyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4 shadow-sm">
        <div class="modal-header">
          <h5 class="modal-title" id="autoBackupReadyModalLabel">è‡ªå‹•å‚™ä»½å®Œæˆ</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          æ¯å°æ™‚è‡ªå‹•å‚™ä»½å·²å®Œæˆï¼Œæ˜¯å¦è¦ä¸‹è¼‰æœ€æ–°çš„å‚™ä»½æª”æ¡ˆï¼Ÿ
          <p class="text-muted mt-2 mb-0">ï¼ˆè«‹å‹™å¿…å°‡å‚™ä»½æª”æ¡ˆå¦¥å–„ä¿å­˜ï¼ï¼‰</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" onclick="triggerAutoBackupDownload()">ä¸‹è¼‰</button>
        </div>
      </div>
    </div>
  </div>

  <!-- å‚™ä»½æç¤º Modal -->
  <div id="backupNoticeModal" class="modal fade" tabindex="-1" aria-labelledby="backupNoticeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4 shadow-sm">
        <div class="modal-header">
          <h5 class="modal-title" id="backupNoticeModalLabel">å‚™ä»½æç¤º</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="backupNoticeContent"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">å¥½çš„</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ç¢ºèªæç¤º Modal -->
  <div id="confirmModal" class="modal fade" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4 shadow-sm">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmModalLabel">è«‹ç¢ºèª</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="confirmMessage"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-danger" id="confirmActionBtn">ç¢ºå®š</button>
        </div>
      </div>
    </div>
  </div>

  <!-- æŸ¥çœ‹æ­·å² Modal -->
  <div id="historyModal" class="modal fade" tabindex="-1" aria-labelledby="historyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered">
      <div class="modal-content rounded-4 shadow-sm">
        <div class="modal-header">
          <h5 class="modal-title" id="historyModalLabel">ğŸ“œ é¡§å®¢æ­·å²ç´€éŒ„</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="historyContent"></div>
      </div>
    </div>
  </div>

  <!-- æ–°å¢é¡§å®¢ Modal -->
  <div id="addCustomerModal" class="modal fade" tabindex="-1" aria-labelledby="addCustomerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4 shadow-sm">
        <div class="modal-header">
          <h5 class="modal-title" id="addCustomerModalLabel">â• æ–°å¢é¡§å®¢</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="newCustomerName" class="form-label">é¡§å®¢åç¨±</label>
            <input type="text" id="newCustomerName" class="form-control" placeholder="è«‹è¼¸å…¥é¡§å®¢åç¨±" />
          </div>
          <div class="mb-3">
            <label for="newCustomerProductType" class="form-label">å•†å“é¡å‹</label>
            <select id="newCustomerProductType" class="form-select">
              <option value="éµè§€éŸ³">éµè§€éŸ³</option>
              <option value="çƒé¾èŒ¶">çƒé¾èŒ¶</option>
              <option value="ç´…èŒ¶">ç´…èŒ¶</option>
              <option value="ç¶ èŒ¶">ç¶ èŒ¶</option>
              <option value="å…¶ä»–">å…¶ä»–</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="newCustomerNote" class="form-label">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
            <textarea id="newCustomerNote" class="form-control" placeholder="å¯ä»¥è¼¸å…¥é¡§å®¢çš„ç‰¹åˆ¥å‚™è¨»" rows="2"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" onclick="addNewCustomer()">æ–°å¢</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ç·¨è¼¯å‚™è¨» Modal -->
  <div id="editNoteModal" class="modal fade" tabindex="-1" aria-labelledby="editNoteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4 shadow-sm">
        <div class="modal-header">
          <h5 class="modal-title" id="editNoteModalLabel">ğŸ“ ç·¨è¼¯å‚™è¨»</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="editCustomerNote" class="form-label">å‚™è¨»å…§å®¹</label>
            <textarea id="editCustomerNote" class="form-control" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" onclick="saveCustomerNote()">å„²å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <!-- å¿«é€Ÿæœå°‹ Modal -->
  <div id="quickSearchModal" class="modal fade" tabindex="-1" aria-labelledby="quickSearchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4 shadow-sm">
        <div class="modal-header">
          <h5 class="modal-title" id="quickSearchModalLabel">ğŸ” å¿«é€Ÿæœå°‹</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="list-group" id="quickSearchList"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- åŠ å¤šæ¯ Modal -->
  <div id="addMultipleCupsModal" class="modal fade" tabindex="-1" aria-labelledby="addMultipleCupsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4 shadow-sm">
        <div class="modal-header">
          <h5 class="modal-title" id="addMultipleCupsModalLabel">â• åŠ å¤šæ¯</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="cupsToAddInput" class="form-label">è¦å¢åŠ çš„æ¯æ•¸</label>
            <input type="number" id="cupsToAddInput" class="form-control" value="1" min="1" />
          </div>
          <div class="mb-3">
            <label for="cupsProductType" class="form-label">å•†å“é¡å‹</label>
            <select id="cupsProductType" class="form-select">
              <option value="éµè§€éŸ³">éµè§€éŸ³</option>
              <option value="çƒé¾èŒ¶">çƒé¾èŒ¶</option>
              <option value="ç´…èŒ¶">ç´…èŒ¶</option>
              <option value="ç¶ èŒ¶">ç¶ èŒ¶</option>
              <option value="å…¶ä»–">å…¶ä»–</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" onclick="confirmAddMultipleCups()">ç¢ºå®šå¢åŠ </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ç·¨è¼¯å•†å“é¡å‹ Modal -->
  <div id="editProductTypeModal" class="modal fade" tabindex="-1" aria-labelledby="editProductTypeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4 shadow-sm">
        <div class="modal-header">
          <h5 class="modal-title" id="editProductTypeModalLabel">ç·¨è¼¯å•†å“é¡å‹</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="editProductTypeInput" class="form-label">å•†å“é¡å‹åç¨±</label>
            <input type="text" id="editProductTypeInput" class="form-control">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="button" class="btn btn-primary" onclick="saveProductTypeEdit()">å„²å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <!-- æ—¥çµå ±è¡¨ Modal -->
  <div id="dailyReportModal" class="modal fade" tabindex="-1" aria-labelledby="dailyReportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
      <div class="modal-content rounded-4 shadow-sm">
        <div class="modal-header">
          <h5 class="modal-title" id="dailyReportModalLabel">ğŸ“Š æ—¥çµå ±è¡¨</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3 d-flex gap-2 align-items-center">
            <label for="dailyReportDate" class="form-label mb-0">é¸æ“‡æ—¥æœŸ</label>
            <input type="date" id="dailyReportDate" class="form-control" onchange="updateDailyReport()">
            <button class="btn btn-outline-primary" onclick="showTodayReport()">ä»Šå¤©</button>
          </div>
          <div id="dailyReportContent"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- æœˆçµå ±è¡¨ Modal -->
  <div id="monthlyReportModal" class="modal fade" tabindex="-1" aria-labelledby="monthlyReportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
      <div class="modal-content rounded-4 shadow-sm">
        <div class="modal-header">
          <h5 class="modal-title" id="monthlyReportModalLabel">ğŸ“ˆ æœˆçµå ±è¡¨</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3 d-flex gap-2 align-items-center">
            <label for="monthlyReportMonth" class="form-label mb-0">é¸æ“‡æœˆä»½</label>
            <input type="month" id="monthlyReportMonth" class="form-control" onchange="updateMonthlyReport()">
            <button class="btn btn-outline-primary" onclick="showCurrentMonthReport()">æœ¬æœˆ</button>
          </div>
          <div id="monthlyReportContent"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- è¨­å®š Modal -->
  <div id="settingsModal" class="modal fade" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content rounded-4 shadow-sm">
        <div class="modal-header">
          <h5 class="modal-title" id="settingsModalLabel">âš™ï¸ è¨­å®š</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="accordion" id="settingsAccordion">
            <!-- ç‰ˆæœ¬æ›´æ–° -->
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#updateSettings" aria-expanded="true" aria-controls="updateSettings">
                  ç‰ˆæœ¬æ›´æ–°
                </button>
              </h2>
              <div id="updateSettings" class="accordion-collapse collapse show" data-bs-parent="#settingsAccordion">
                <div class="accordion-body">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>ç›®å‰ç‰ˆæœ¬ï¼š<span id="currentVersion" class="fw-bold">1.0.0</span></span>
                    <small class="text-muted">ä¸Šæ¬¡æª¢æŸ¥ï¼š<span id="lastCheckTime">å°šæœªæª¢æŸ¥</span></small>
                  </div>
                  <button type="button" class="btn btn-primary w-100" onclick="checkForUpdates(false)">
                    <i class="bi bi-arrow-clockwise"></i> æª¢æŸ¥æ›´æ–°
                  </button>
                </div>
              </div>
            </div>

            <!-- åŸºæœ¬è¨­å®š -->
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#basicSettings" aria-expanded="false" aria-controls="basicSettings">
                  åŸºæœ¬è¨­å®š
                </button>
              </h2>
              <div id="basicSettings" class="accordion-collapse collapse" data-bs-parent="#settingsAccordion">
                <div class="accordion-body">
                  <div class="mb-3">
                    <label for="autoBackupIntervalInput" class="form-label">è‡ªå‹•å‚™ä»½é–“éš” (å°æ™‚)</label>
                    <input type="number" id="autoBackupIntervalInput" class="form-control" placeholder="1" min="1" />
                  </div>
                  <div class="mb-3 form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="enablePredictiveSorting">
                    <label class="form-check-label" for="enablePredictiveSorting">å•Ÿç”¨é æ¸¬æ’åº</label>
                  </div>
                  <div class="mb-3 form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="enableDarkMode">
                    <label class="form-check-label" for="enableDarkMode">å•Ÿç”¨æ·±è‰²æ¨¡å¼</label>
                  </div>
                  <div class="mb-3 form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="enableDailyReport">
                    <label class="form-check-label" for="enableDailyReport">å•Ÿç”¨æ—¥çµå ±è¡¨</label>
                  </div>
                   <div class="mb-3 form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="enableMonthlyReport">
                    <label class="form-check-label" for="enableMonthlyReport">å•Ÿç”¨æœˆçµå ±è¡¨</label>
                  </div>
                  <!-- å…¶ä»–åŸºæœ¬è¨­å®š -->
                </div>
              </div>
            </div>

            <!-- å•†å“é¡å‹ç®¡ç† -->
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#productTypeSettings" aria-expanded="false" aria-controls="productTypeSettings">
                  å•†å“é¡å‹ç®¡ç†
                </button>
              </h2>
              <div id="productTypeSettings" class="accordion-collapse collapse" data-bs-parent="#settingsAccordion">
                <div class="accordion-body">
                  <div class="input-group mb-2">
                    <input type="text" id="newProductType" class="form-control" placeholder="è¼¸å…¥æ–°å•†å“é¡å‹">
                    <button class="btn btn-outline-primary" onclick="addProductType()">æ–°å¢</button>
                  </div>
                  <div id="productTypeList" class="list-group">
                    <!-- å•†å“é¡å‹åˆ—è¡¨å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
                  </div>
                </div>
              </div>
            </div>

            <!-- å ±è¡¨è¨­å®š -->
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#reportSettings" aria-expanded="false" aria-controls="reportSettings">
                  å ±è¡¨è¨­å®š
                </button>
              </h2>
              <div id="reportSettings" class="accordion-collapse collapse" data-bs-parent="#settingsAccordion">
                <div class="accordion-body">
                  <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" onclick="hideSettingsModal(); showDailyReport();">ğŸ“Š æŸ¥çœ‹æ—¥çµå ±è¡¨</button>
                    <button class="btn btn-outline-primary" onclick="hideSettingsModal(); showMonthlyReport();">ğŸ“ˆ æŸ¥çœ‹æœˆçµå ±è¡¨</button>
                  </div>
                  <!-- å…¶ä»–å ±è¡¨è¨­å®š -->
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
          <button type="button" class="btn btn-primary" onclick="saveSettings()">å„²å­˜è¨­å®š</button>
        </div>
      </div>
    </div>
  </div>

  <!-- JS å€å¡Š -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // å…¨åŸŸè®Šæ•¸
    let currentEditingCustomer = null;
    let currentCustomerToAddCups = null;
    let autoBackupIntervalId = null; // ç”¨æ–¼å„²å­˜ setInterval çš„ ID

    // åŸºç¤è³‡æ–™æ“ä½œå‡½æ•¸
    function getData() {
      return JSON.parse(localStorage.getItem('cups') || '{}');
    }

    function saveData(data) {
      localStorage.setItem('cups', JSON.stringify(data));
    }

    // UI è¼”åŠ©å‡½æ•¸
    function showToast(message, type = 'success') {
      const toastContainer = document.querySelector('.toast-container');
      const toast = document.createElement('div');
      toast.className = `toast align-items-center text-white bg-${type} border-0`;
      toast.setAttribute('role', 'alert');
      toast.setAttribute('aria-live', 'assertive');
      toast.setAttribute('aria-atomic', 'true');
      
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      `;
      
      toastContainer.appendChild(toast);
      const bsToast = new bootstrap.Toast(toast);
      bsToast.show();
      
      toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
      });
    }

    function updateStats() {
      const data = getData();
      const customers = Object.keys(data);
      const totalCups = customers.reduce((sum, name) => sum + data[name].count, 0);
      
      document.getElementById('totalCustomers').textContent = customers.length;
      document.getElementById('totalCups').textContent = totalCups;
      const now = new Date();
      // ä½¿ç”¨æœ¬åœ°æ™‚é–“
      const timeStr = now.toLocaleString('zh-TW', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false,
        timeZone: 'Asia/Taipei'
      }).replace(/\//g, '/');
      document.getElementById('lastUpdate').textContent = timeStr;
    }

    // æœå°‹ç›¸é—œå‡½æ•¸
    function showQuickSearch() {
      const data = getData();
      const list = document.getElementById('quickSearchList');
      list.innerHTML = '';

      Object.keys(data).sort().forEach(name => {
        const item = document.createElement('button');
        item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
        item.innerHTML = `
          <span>${name}</span>
          <span class="badge bg-primary rounded-pill">${data[name].count} æ¯</span>
        `;
        item.onclick = () => {
          document.getElementById('searchInput').value = name;
          render();
          bootstrap.Modal.getInstance(document.getElementById('quickSearchModal')).hide();
        };
        list.appendChild(item);
      });
      
      new bootstrap.Modal(document.getElementById('quickSearchModal')).show();
    }

    // å‚™è¨»ç›¸é—œå‡½æ•¸
    function showEditNoteModal(name) {
      currentEditingCustomer = name;
      const data = getData();
      document.getElementById('editCustomerNote').value = data[name].note || '';
      new bootstrap.Modal(document.getElementById('editNoteModal')).show();
    }

    function saveCustomerNote() {
      if (!currentEditingCustomer) return;
      
      const note = document.getElementById('editCustomerNote').value.trim();
      const data = getData();
      data[currentEditingCustomer].note = note;
      saveData(data);
      
      bootstrap.Modal.getInstance(document.getElementById('editNoteModal')).hide();
      showToast('å‚™è¨»å·²æ›´æ–°');
      render();
    }

    // é¡§å®¢ç®¡ç†å‡½æ•¸
    function showAddCustomerModal() {
      const modal = new bootstrap.Modal(document.getElementById('addCustomerModal'));
      document.getElementById('newCustomerName').value = '';
      document.getElementById('newCustomerProductType').value = 'éµè§€éŸ³';
      document.getElementById('newCustomerNote').value = '';
      modal.show();
    }

    function addNewCustomer() {
      const name = document.getElementById('newCustomerName').value.trim();
      const note = document.getElementById('newCustomerNote').value.trim();
      const productType = document.getElementById('newCustomerProductType').value;
      
      if (!name) {
        showToast('è«‹è¼¸å…¥é¡§å®¢åç¨±', 'danger');
        return;
      }

      const data = getData();
      if (data[name]) {
        showToast('æ­¤é¡§å®¢å·²å­˜åœ¨', 'danger');
        return;
      }

      data[name] = { 
        count: 0, 
        log: [],
        note: note,
        productType: productType,
        createdAt: new Date().toISOString()
      };
      saveData(data);
      
      const modal = bootstrap.Modal.getInstance(document.getElementById('addCustomerModal'));
      modal.hide();
      
      showToast('é¡§å®¢æ–°å¢æˆåŠŸ');
      render();
    }

    function addCup(name, quantity = 1) {
      const data = getData();
      if (!data[name]) data[name] = { count: 0, log: [], createdAt: new Date().toISOString() };
      data[name].count += quantity;
      const now = new Date();
      // ä½¿ç”¨æœ¬åœ°æ™‚é–“
      const timeStr = now.toLocaleString('zh-TW', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false,
        timeZone: 'Asia/Taipei'
      }).replace(/\//g, '/');
      data[name].log.push(`+${quantity} æ¯ï¼ˆ${timeStr}ï¼‰`);
      saveData(data);
      showToast(`å·²ç‚º ${name} å¢åŠ  ${quantity} æ¯`);
      render();
    }

    function removeCup(name) {
      const data = getData();
      if (!data[name] || data[name].count <= 0) {
        showToast('ç„¡æ³•æ‰£é™¤ï¼Œè©²é¡§å®¢å°šç„¡æ¯æ•¸', 'danger');
        return;
      }
      data[name].count--;
      const now = new Date();
      // ä½¿ç”¨æœ¬åœ°æ™‚é–“
      const timeStr = now.toLocaleString('zh-TW', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false,
        timeZone: 'Asia/Taipei'
      }).replace(/\//g, '/');
      data[name].log.push(`-1 æ¯ ${data[name].productType || 'æœªæŒ‡å®š'}ï¼ˆ${timeStr}ï¼‰`);
      saveData(data);
      showToast(`å·²ç‚º ${name} æ‰£ä¸€æ¯`);
      render();
    }

    function removeCustomer(name) {
      const confirmModalElement = document.getElementById('confirmModal');
      const confirmMessageElement = document.getElementById('confirmMessage');
      const confirmActionBtn = document.getElementById('confirmActionBtn');

      confirmModalElement.querySelector('.modal-title').textContent = 'ç¢ºèªç§»é™¤';
      confirmMessageElement.innerHTML = `ç¢ºå®šè¦ç§»é™¤é¡§å®¢ <strong>${name}</strong> å—ï¼Ÿ<br>æ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`;
      
      // ç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨
      const newConfirmActionBtn = confirmActionBtn.cloneNode(true);
      confirmActionBtn.parentNode.replaceChild(newConfirmActionBtn, confirmActionBtn);

      // æ–°å¢æ–°çš„äº‹ä»¶ç›£è½å™¨
      newConfirmActionBtn.addEventListener('click', () => {
      const data = getData();
      delete data[name];
      saveData(data);
        showToast(`å·²ç§»é™¤é¡§å®¢ ${name}`);
      render();
        bootstrap.Modal.getInstance(confirmModalElement).hide();
      });

      const confirmModal = new bootstrap.Modal(confirmModalElement);
      confirmModal.show();
    }

    function viewHistory(name) {
      const data = getData();
      const log = data[name]?.log || [];
      document.getElementById('historyContent').innerHTML =
        `<ul class="list-group">${log.map(item => `<li class="list-group-item">${item}</li>`).join('')}</ul>`;
      new bootstrap.Modal(document.getElementById('historyModal')).show();
    }

    // å‚™ä»½ç›¸é—œå‡½æ•¸
    function backup() {
      const data = getData();
      const now = new Date();
      const formattedDate = now.toLocaleString('zh-TW', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      }).replace(/[/:]/g, '-').replace(/\s/g, '_');

      // è®€å–ç•¶å‰æ‰€æœ‰è¨­å®š
      const currentSettings = {
        autoBackupInterval: localStorage.getItem('autoBackupInterval') || '1',
        predictiveSortingEnabled: localStorage.getItem('predictiveSortingEnabled') || 'false',
        darkModeEnabled: localStorage.getItem('darkModeEnabled') || 'false',
        enableDailyReport: localStorage.getItem('enableDailyReport') || 'false',
        enableMonthlyReport: localStorage.getItem('enableMonthlyReport') || 'false'
      };

      const backupData = {
        version: '1.1', // æ›´æ–°ç‰ˆæœ¬è™Ÿ
        exportDate: now.toISOString(),
        data: data,
        settings: currentSettings,
        totalCustomers: Object.keys(data).length,
        totalCups: Object.values(data).reduce((sum, customer) => sum + customer.count, 0)
      };

      const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `å¯„æ¯å‚™ä»½_${formattedDate}.json`;
      a.click();

      showBackupNoticeModal('å‚™ä»½æª”æ¡ˆå·²ä¸‹è¼‰', `æª”æ¡ˆåç¨±ï¼š<strong>å¯„æ¯å‚™ä»½_${formattedDate}.json</strong><hr><p class="mb-0"><strong>iOS ä½¿ç”¨è€…è«‹æ³¨æ„ï¼š</strong><br>1. é»æ“Šä¸‹è¼‰çš„æª”æ¡ˆ<br>2. é¸æ“‡ã€Œå„²å­˜åˆ°æª”æ¡ˆã€<br>3. é¸æ“‡ã€Œæˆ‘çš„ iPhoneã€æˆ–ã€ŒiCloud é›²ç¢Ÿã€<br>4. å»ºè­°å»ºç«‹ã€Œå¯„æ¯å‚™ä»½ã€è³‡æ–™å¤¾å­˜æ”¾<br><br><strong>è«‹å‹™å¿…å°‡å‚™ä»½æª”æ¡ˆå¦¥å–„ä¿å­˜ï¼Œé¿å…è³‡æ–™éºå¤±ï¼</strong></p>`);
    }

    // å°‡å‚™ä»½æç¤ºæ”¹ç‚º Modal
    function showBackupNoticeModal(title, message) {
      const modalElement = document.getElementById('backupNoticeModal');
      const modalTitle = modalElement.querySelector('.modal-title');
      const modalBody = modalElement.querySelector('.modal-body');
      
      modalTitle.textContent = title;
      modalBody.innerHTML = message;
      
      const modal = new bootstrap.Modal(modalElement);
      modal.show();
    }

    function importBackup(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const imported = JSON.parse(e.target.result);
          if (!imported.data) throw new Error('å‚™ä»½æ ¼å¼éŒ¯èª¤ï¼šç¼ºå°‘é¡§å®¢è³‡æ–™');
          
          // å¦‚æœå‚™ä»½åŒ…å«è¨­å®šï¼Œå‰‡åŒ¯å…¥è¨­å®š
          if (imported.settings) {
            localStorage.setItem('autoBackupInterval', imported.settings.autoBackupInterval || '1');
            localStorage.setItem('predictiveSortingEnabled', imported.settings.predictiveSortingEnabled || 'false');
            localStorage.setItem('darkModeEnabled', imported.settings.darkModeEnabled || 'false');
            localStorage.setItem('enableDailyReport', imported.settings.enableDailyReport || 'false');
            localStorage.setItem('enableMonthlyReport', imported.settings.enableMonthlyReport || 'false');

            // æ‡‰ç”¨åŒ¯å…¥çš„è¨­å®š
            setAutoBackupInterval(parseInt(imported.settings.autoBackupInterval || '1'));
            applyDarkMode(imported.settings.darkModeEnabled === 'true');
          }

          // åŒ¯å…¥é¡§å®¢è³‡æ–™
          const existing = getData();
          const merged = { ...existing, ...imported.data };
          saveData(merged);
          
          showBackupNoticeModal('åŒ¯å…¥æˆåŠŸï¼', `âœ… å·²æˆåŠŸåŒ¯å…¥ ${Object.keys(imported.data).length} ç­†é¡§å®¢è³‡æ–™${imported.totalCups ? `<br>ç¸½æ¯æ•¸ï¼š${imported.totalCups} æ¯` : ''}`);
          render();
        } catch (err) {
          showBackupNoticeModal('åŒ¯å…¥å¤±æ•—', `âŒ ${err.message}`);
          console.error('åŒ¯å…¥éŒ¯èª¤:', err);
        }
      };
      reader.readAsText(file);
    }

    // é æ¸¬ç›¸é—œå‡½æ•¸
    function calculatePredictedNextVisit(customerLog) {
        // 1. åªå–ææ¯è¨˜éŒ„
        const removeCupLogs = (customerLog || []).filter(log => {
            if (typeof log === 'string') {
                return log.startsWith('-1 æ¯');
            } else if (typeof log === 'object' && log !== null && log.type === 'remove') {
                return true;
            }
            return false;
        });

        if (removeCupLogs.length < 2) return null;

        // è§£ææ—¥æœŸä¸¦æ’åº (å¾èˆŠåˆ°æ–°)
        const dates = removeCupLogs.map(log => {
            let dateString;
            if (typeof log === 'string') {
                const match = log.match(/ï¼ˆ(.*?)ï¼‰/);
                dateString = match ? match[1] : null;
            } else if (typeof log === 'object' && log !== null && log.timestamp) {
                dateString = log.timestamp;
            }
            
            if (!dateString) return null;
            
            const date = new Date(dateString);
            return isNaN(date.getTime()) ? null : date;
        }).filter(date => date !== null).sort((a, b) => a.getTime() - b.getTime());

        // å¦‚æœè§£æå‡ºçš„æœ‰æ•ˆæ—¥æœŸå°‘æ–¼å…©ç­†ï¼Œè¿”å› null
        if (dates.length < 2) {
            return null;
        }

        // è¨ˆç®—æ™‚é–“é–“éš” (æ¯«ç§’)
        const intervals = [];
        for (let i = 1; i < dates.length; i++) {
            intervals.push(dates[i].getTime() - dates[i - 1].getTime());
        }

        // å¦‚æœæ²’æœ‰æœ‰æ•ˆçš„é–“éš”ï¼Œè¿”å› null
        if (intervals.length === 0) {
            return null;
        }

        // è¨ˆç®—å¹³å‡é–“éš” (æ¯«ç§’)
        const averageInterval = intervals.reduce((sum, interval) => sum + interval, 0) / intervals.length;

        // é æ¸¬ä¸‹ä¸€æ¬¡ä¾†è¨ªæ—¥æœŸ = æœ€å¾Œä¸€æ¬¡ææ¯æ—¥æœŸ + å¹³å‡é–“éš”
        const lastVisitDate = dates[dates.length - 1];
        const predictedDate = new Date(lastVisitDate.getTime() + averageInterval);

        return predictedDate;
    }

    // æ¸²æŸ“å‡½æ•¸
    function render() {
      const data = getData();
      const list = document.getElementById('customerList');
      const searchKeyword = document.getElementById('searchInput').value.trim().toLowerCase();
      list.innerHTML = '';

      let filteredNames = Object.keys(data).filter(name =>
        name.toLowerCase().includes(searchKeyword)
      );

      // æª¢æŸ¥é æ¸¬æ’åºè¨­å®š
      const predictiveSortingEnabled = localStorage.getItem('predictiveSortingEnabled') === 'true';

      let customerPredictions = null; // å°‡è®Šæ•¸è²æ˜ç§»åˆ°é€™è£¡

      if (predictiveSortingEnabled) {
          // è¨ˆç®—æ¯å€‹é¡§å®¢çš„é æ¸¬æ—¥æœŸä¸¦å„²å­˜èµ·ä¾†ä»¥ä¾¿æ’åº
          customerPredictions = filteredNames.map(name => {
              const predictedDate = calculatePredictedNextVisit(data[name].log || []);
              return { name, predictedDate };
          });

          // æ ¹æ“šé æ¸¬æ—¥æœŸæ’åº
          customerPredictions.sort((a, b) => {
              // æ²’æœ‰é æ¸¬æ—¥æœŸçš„æ’åœ¨å¾Œé¢
              if (a.predictedDate === null && b.predictedDate === null) return 0;
              if (a.predictedDate === null) return 1;
              if (b.predictedDate === null) return -1;

              // æŒ‰é æ¸¬æ—¥æœŸæ’åº (å¾æ—©åˆ°æ™š)
              return a.predictedDate.getTime() - b.predictedDate.getTime();
          });

          // æ›´æ–° filteredNames ç‚ºæ’åºå¾Œçš„åç¨±åˆ—è¡¨
          filteredNames = customerPredictions.map(item => item.name);

      } else {
          // å¦‚æœé æ¸¬æ’åºæœªå•Ÿç”¨ï¼ŒæŒ‰åç¨±å­—æ¯é †åºæ’åº
          filteredNames.sort();
      }

      if (filteredNames.length === 0) {
        list.innerHTML = `
          <div class="text-center">
            <p class="text-muted">æ‰¾ä¸åˆ°ç¬¦åˆçš„é¡§å®¢</p>
            <button class="btn btn-primary" onclick="showAddCustomerModal()">â• æ–°å¢é¡§å®¢</button>
          </div>`;
        return;
      }

      // æ–°å¢é¡§å®¢æŒ‰éˆ•
      const addButton = document.createElement('div');
      addButton.className = 'text-center mb-3';
      addButton.innerHTML = '<button class="btn btn-primary" onclick="showAddCustomerModal()">â• æ–°å¢é¡§å®¢</button>';
      list.appendChild(addButton);

      for (const name of filteredNames) {
        const customer = data[name];
        const lowCup = customer.count < 2;

        const card = document.createElement('div');
        card.className = 'card shadow-sm p-3 customer-card';
        card.innerHTML = `
          <div>
            <h5 class="mb-1">${name}ï¼š
              <span class="badge ${lowCup ? 'badge-low' : 'bg-primary'}">${customer.count} æ¯</span>
              ${customer.note ? `<span class="note-badge" onclick="showEditNoteModal('${name}')">ğŸ“</span>` : ''}
            </h5>
            <small class="text-muted d-block mb-2">
              ${customer.productType ? `å•†å“é¡å‹ï¼š${customer.productType}` : ''}
              ${customer.note ? `<br>${customer.note}` : ''}
            </small>
            ${predictiveSortingEnabled && customerPredictions ? 
                `<small class="text-muted">é æ¸¬ä¸‹æ¬¡ï¼š${customerPredictions.find(item => item.name === name)?.predictedDate?.toLocaleString() || 'ç„¡æ•¸æ“š'}</small>` 
                : ''}
          </div>
          <div class="d-flex justify-content-end align-items-center flex-wrap gap-2">
            <div class="btn-group">
              <button class="btn btn-success btn-sm" onclick="showAddMultipleCupsModal('${name}')">â•</button>
              <button class="btn btn-secondary btn-sm" onclick="removeCup('${name}')">â–</button>
            </div>
            <button class="btn btn-outline-info btn-sm" onclick="viewHistory('${name}')">ğŸ“œ æ­·å²</button>
            <button class="btn btn-outline-danger btn-sm" onclick="removeCustomer('${name}')">ğŸ—‘ï¸ ç§»é™¤</button>
          </div>
        `;

        list.appendChild(card);
      }

      updateStats();
    }

    // åŠ å¤šæ¯ Modal ç›¸é—œå‡½æ•¸
    function showAddMultipleCupsModal(name) {
      currentCustomerToAddCups = name; // è¨˜éŒ„ç•¶å‰è¦åŠ æ¯çš„é¡§å®¢
      document.getElementById('cupsToAddInput').value = '1'; // é è¨­å€¼è¨­ç‚º 1
      const modal = new bootstrap.Modal(document.getElementById('addMultipleCupsModal'));
      modal.show();
    }

    function confirmAddMultipleCups() {
      const cupsToAdd = parseInt(document.getElementById('cupsToAddInput').value);
      const productType = document.getElementById('cupsProductType').value;
      const name = currentCustomerToAddCups;

      if (isNaN(cupsToAdd) || cupsToAdd <= 0) {
        showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ¯æ•¸', 'danger');
        return;
      }

      const data = getData();
      if (!data[name]) data[name] = { count: 0, log: [], createdAt: new Date().toISOString() };
      
      data[name].productType = productType;
      data[name].count += cupsToAdd;
      const now = new Date();
      // ä½¿ç”¨æœ¬åœ°æ™‚é–“
      const timeStr = now.toLocaleString('zh-TW', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false,
        timeZone: 'Asia/Taipei'
      }).replace(/\//g, '/');
      data[name].log.push(`+${cupsToAdd} æ¯ ${productType}ï¼ˆ${timeStr}ï¼‰`);
      
      saveData(data);
      showToast(`å·²ç‚º ${name} å¢åŠ  ${cupsToAdd} æ¯ ${productType}`);
      
      const modal = bootstrap.Modal.getInstance(document.getElementById('addMultipleCupsModal'));
      modal.hide();
      render();
    }

    // å•†å“é¡å‹ç®¡ç†ç›¸é—œå‡½æ•¸
    function getProductTypes() {
      try {
        const item = localStorage.getItem('productTypes');
        // å¦‚æœ item æ˜¯ null, undefined å­—ä¸², æˆ–ç©ºå­—ä¸²ï¼Œå‰‡ä½¿ç”¨é è¨­å•†å“é¡å‹
        if (item === null || item === 'undefined' || item === '') {
            console.log('LocalStorage productTypes not found or invalid, using default types.');
            // è¿”å›é è¨­å•†å“é¡å‹
            return ["éµè§€éŸ³", "çƒé¾èŒ¶", "ç´…èŒ¶", "ç¶ èŒ¶", "å…¶ä»–"];
        }

        const productTypes = JSON.parse(item); // å˜—è©¦è§£æè®€å–åˆ°çš„å­—ä¸²
         // ç¢ºä¿è§£æçµæœæ˜¯é™£åˆ—
        if (!Array.isArray(productTypes)) {
            console.error('productTypes in localStorage is not an array after parsing, using default types.');
             // è§£æå¤±æ•—ä¹Ÿä½¿ç”¨é è¨­å•†å“é¡å‹
            return ["éµè§€éŸ³", "çƒé¾èŒ¶", "ç´…èŒ¶", "ç¶ èŒ¶", "å…¶ä»–"];
        }
        return productTypes;
      } catch (error) {
        console.error('è®€å–å•†å“é¡å‹æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š', error);
         // ç™¼ç”Ÿè§£æéŒ¯èª¤æ™‚è¿”å›é è¨­å•†å“é¡å‹
        return ["éµè§€éŸ³", "çƒé¾èŒ¶", "ç´…èŒ¶", "ç¶ èŒ¶", "å…¶ä»–"];
      }
    }

    function saveProductTypes(productTypes) {
      try {
        localStorage.setItem('productTypes', JSON.stringify(productTypes));
      } catch (error) {
        console.error('å„²å­˜å•†å“é¡å‹æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š', error);
      }
    }

    // è¼‰å…¥å•†å“é¡å‹åˆ—è¡¨åˆ°è¨­å®š Modal
    function loadProductTypes() {
      const productTypeListElement = document.getElementById('productTypeList');
      if (!productTypeListElement) return; // ç¢ºä¿å…ƒç´ å­˜åœ¨

      const productTypes = getProductTypes();
      productTypeListElement.innerHTML = ''; // æ¸…ç©ºç¾æœ‰åˆ—è¡¨

      if (productTypes.length === 0) {
          // å¦‚æœ localStorage æ²’æœ‰ï¼Œé¡¯ç¤ºé è¨­é¸é …æç¤ºæˆ–ç›´æ¥è¼‰å…¥é è¨­ï¼Ÿ
          // ç›®å‰ getProductTypes åœ¨æ²’æœ‰å„²å­˜æ™‚æœƒè¿”å›é è¨­ï¼Œæ‰€ä»¥é€™è£¡ç†è«–ä¸Šä¸æœƒæ˜¯ç©º
          // ä½†ç‚ºä¿éšªèµ·è¦‹ï¼Œå¯ä»¥åŠ ä¸€å€‹æç¤ºæˆ–è¼‰å…¥é è¨­ UI
      }

      productTypes.forEach(type => {
        const item = document.createElement('div');
        item.className = 'list-group-item d-flex justify-content-between align-items-center';
        item.innerHTML = `
          <span>${type}</span>
          <button type="button" class="btn btn-sm btn-danger" onclick="removeProductType('${escapeHtml(type)}')">ç§»é™¤</button>
        `;
        productTypeListElement.appendChild(item);
      });
       // æ›´æ–°æ–°å¢é¡§å®¢ Modal ä¸­çš„å•†å“é¡å‹ä¸‹æ‹‰é¸å–®
      updateProductTypeSelects();
    }

    // æ–°å¢å•†å“é¡å‹
    function addProductType() {
      const newProductTypeInput = document.getElementById('newProductType');
      const newType = newProductTypeInput.value.trim();
      
      if (newType === '') {
        showToast('è«‹è¼¸å…¥å•†å“é¡å‹åç¨±', 'warning');
        return;
      }

      const productTypes = getProductTypes();
      if (productTypes.includes(newType)) {
        showToast('å•†å“é¡å‹å·²å­˜åœ¨', 'warning');
        return;
      }

      productTypes.push(newType);
      saveProductTypes(productTypes);
      showToast('å•†å“é¡å‹æ–°å¢æˆåŠŸ');
      newProductTypeInput.value = '';
      loadProductTypes(); // é‡æ–°è¼‰å…¥åˆ—è¡¨
    }

    // ç§»é™¤å•†å“é¡å‹
    function removeProductType(type) {
       // å…ˆéš±è—è¨­å®š Modalï¼Œç¢ºä¿ç¢ºèªè¦–çª—åœ¨æœ€ä¸Šå±¤
      hideSettingsModal();

      const confirmModalElement = document.getElementById('confirmModal');
      const confirmMessageElement = document.getElementById('confirmMessage');
      const confirmActionBtn = document.getElementById('confirmActionBtn');

      confirmModalElement.querySelector('.modal-title').textContent = 'ç¢ºèªç§»é™¤å•†å“é¡å‹';
      confirmMessageElement.innerHTML = `ç¢ºå®šè¦ç§»é™¤å•†å“é¡å‹ <strong>${escapeHtml(type)}</strong> å—ï¼Ÿ`;
      
      // ç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨
      const newConfirmActionBtn = confirmActionBtn.cloneNode(true);
      confirmActionBtn.parentNode.replaceChild(newConfirmActionBtn, confirmActionBtn);

      // æ–°å¢æ–°çš„äº‹ä»¶ç›£è½å™¨
      newConfirmActionBtn.addEventListener('click', () => {
        let productTypes = getProductTypes();
        productTypes = productTypes.filter(t => t !== type);
        saveProductTypes(productTypes);
        showToast('å•†å“é¡å‹å·²ç§»é™¤');
        loadProductTypes(); // é‡æ–°è¼‰å…¥åˆ—è¡¨
        bootstrap.Modal.getInstance(confirmModalElement).hide();
      });

      const confirmModal = new bootstrap.Modal(confirmModalElement);
      confirmModal.show();
    }

    // æ›´æ–°æ–°å¢é¡§å®¢ Modal ä¸­çš„å•†å“é¡å‹ä¸‹æ‹‰é¸å–®
    function updateProductTypeSelects() {
      const productTypeSelect = document.getElementById('newCustomerProductType');
      if (!productTypeSelect) return; // ç¢ºä¿å…ƒç´ å­˜åœ¨
      
      const productTypes = getProductTypes();
      // æ¸…ç©ºç¾æœ‰é¸é …ï¼ˆä¿ç•™ç¬¬ä¸€å€‹é è¨­é¸é …ï¼Œæˆ–å…¨éƒ¨æ¸…ç©ºè‡ªè¡Œæ±ºå®šï¼‰
      productTypeSelect.innerHTML = '';

       // åŠ å…¥é è¨­é¸é …ï¼ˆå¦‚æœéœ€è¦ï¼‰
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = 'è«‹é¸æ“‡å•†å“é¡å‹';
      productTypeSelect.appendChild(defaultOption);

      productTypes.forEach(type => {
        const option = document.createElement('option');
        option.value = type;
        option.textContent = type;
        productTypeSelect.appendChild(option);
      });
    }

    // HTML escaping å‡½æ•¸ï¼Œé˜²æ­¢ XSS æ”»æ“Š
    function escapeHtml(unsafe) {
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function editProductType(oldType) {
      const modal = new bootstrap.Modal(document.getElementById('editProductTypeModal'));
      document.getElementById('editProductTypeInput').value = oldType;
      document.getElementById('editProductTypeInput').dataset.oldType = oldType;
      modal.show();
    }

    function saveProductTypeEdit() {
      const input = document.getElementById('editProductTypeInput');
      const oldType = input.dataset.oldType;
      const newType = input.value.trim();

      if (!newType) {
        showToast('è«‹è¼¸å…¥å•†å“é¡å‹åç¨±', 'danger');
        return;
      }

      const types = getProductTypes();
      if (types.includes(newType) && newType !== oldType) {
        showToast('æ­¤å•†å“é¡å‹å·²å­˜åœ¨', 'danger');
        return;
      }

      // æ›´æ–°å•†å“é¡å‹åˆ—è¡¨
      const index = types.indexOf(oldType);
      types[index] = newType;
      saveProductTypes(types);

      // æ›´æ–°æ‰€æœ‰é¡§å®¢çš„å•†å“é¡å‹
      const data = getData();
      Object.values(data).forEach(customer => {
        if (customer.productType === oldType) {
          customer.productType = newType;
        }
      });
      saveData(data);

      bootstrap.Modal.getInstance(document.getElementById('editProductTypeModal')).hide();
      showToast('å•†å“é¡å‹æ›´æ–°æˆåŠŸ');
      renderProductTypeList();
      updateProductTypeSelects();
      render(); // é‡æ–°æ¸²æŸ“é¡§å®¢åˆ—è¡¨
    }

    function deleteProductType(type) {
      if (!confirm(`ç¢ºå®šè¦åˆªé™¤å•†å“é¡å‹ã€Œ${type}ã€å—ï¼Ÿ\næ³¨æ„ï¼šæ­¤æ“ä½œæœƒå°‡ä½¿ç”¨æ­¤å•†å“é¡å‹çš„é¡§å®¢æ”¹ç‚ºã€ŒæœªæŒ‡å®šã€`)) {
        return;
      }

      const types = getProductTypes();
      const index = types.indexOf(type);
      if (index > -1) {
        types.splice(index, 1);
        saveProductTypes(types);

        // æ›´æ–°æ‰€æœ‰ä½¿ç”¨æ­¤å•†å“é¡å‹çš„é¡§å®¢
        const data = getData();
        Object.values(data).forEach(customer => {
          if (customer.productType === type) {
            customer.productType = 'æœªæŒ‡å®š';
          }
        });
        saveData(data);

        showToast('å•†å“é¡å‹å·²åˆªé™¤');
        renderProductTypeList();
        updateProductTypeSelects();
        render(); // é‡æ–°æ¸²æŸ“é¡§å®¢åˆ—è¡¨
      }
    }

    function renderProductTypeList() {
      const list = document.getElementById('productTypeList');
      const types = getProductTypes();
      
      list.innerHTML = types.map(type => `
        <div class="list-group-item d-flex justify-content-between align-items-center">
          <span>${type}</span>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary" onclick="editProductType('${type}')">âœï¸</button>
            <button class="btn btn-outline-danger" onclick="deleteProductType('${type}')">ğŸ—‘ï¸</button>
          </div>
        </div>
      `).join('');
    }

    // è¨­å®šç›¸é—œå‡½æ•¸
    function showSettingsModal() {
      // è®€å–ç•¶å‰è¨­å®šå€¼
      document.getElementById('autoBackupIntervalInput').value = localStorage.getItem('autoBackupInterval') || '1';
      document.getElementById('enablePredictiveSorting').checked = localStorage.getItem('predictiveSortingEnabled') === 'true';
      document.getElementById('enableDarkMode').checked = localStorage.getItem('darkModeEnabled') === 'true';
      document.getElementById('enableDailyReport').checked = localStorage.getItem('enableDailyReport') === 'true';
      document.getElementById('enableMonthlyReport').checked = localStorage.getItem('enableMonthlyReport') === 'true';

      // æ¸²æŸ“å•†å“é¡å‹åˆ—è¡¨
      renderProductTypeList();

      const modal = new bootstrap.Modal(document.getElementById('settingsModal'));
      modal.show();
    }

    function saveAutoBackupSetting() {
      const inputElement = document.getElementById('autoBackupIntervalInput');
      const intervalHours = parseInt(inputElement.value);

      if (isNaN(intervalHours) || intervalHours < 1) {
        showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„å‚™ä»½é–“éš” (è‡³å°‘ç‚º 1 å°æ™‚)', 'danger');
        inputElement.value = '1';
        return;
      }

      // å„²å­˜æ‰€æœ‰è¨­å®š
      localStorage.setItem('autoBackupInterval', intervalHours.toString());
      localStorage.setItem('predictiveSortingEnabled', document.getElementById('enablePredictiveSorting').checked.toString());
      localStorage.setItem('enableDarkMode', document.getElementById('enableDarkMode').checked.toString());

      // æ›´æ–°æ·±è‰²æ¨¡å¼
      applyDarkMode(document.getElementById('enableDarkMode').checked);

      // æ›´æ–°è‡ªå‹•å‚™ä»½è¨ˆæ™‚å™¨
      setAutoBackupInterval(intervalHours);

      showToast('è¨­å®šå·²å„²å­˜');

      // é—œé–‰ Modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('settingsModal'));
      modal.hide();

      // é‡æ–°æ¸²æŸ“
      render();
    }

    // æ·±è‰²æ¨¡å¼ç›¸é—œå‡½æ•¸
    function applyDarkMode(enabled) {
      if (enabled) {
        document.body.classList.add('dark-mode');
      } else {
        document.body.classList.remove('dark-mode');
      }
    }

    function setAutoBackupInterval(hours) {
      // æ¸…é™¤ä¹‹å‰çš„è¨ˆæ™‚å™¨
      if (autoBackupIntervalId !== null) {
        clearInterval(autoBackupIntervalId);
    }

      // è¨­å®šæ–°çš„è¨ˆæ™‚å™¨ (è½‰æ›ç‚ºæ¯«ç§’)
      const intervalMilliseconds = hours * 60 * 60 * 1000;
      autoBackupIntervalId = setInterval(autoBackup, intervalMilliseconds);
      console.log(`è‡ªå‹•å‚™ä»½é–“éš”å·²è¨­å®šç‚ºæ¯ ${hours} å°æ™‚ã€‚`);
    }

    // è‡ªå‹•å‚™ä»½
    function autoBackup() {
      // ä¸å†ç›´æ¥èª¿ç”¨ backup()ï¼Œè€Œæ˜¯é¡¯ç¤º Modal
      const modal = new bootstrap.Modal(document.getElementById('autoBackupReadyModal'));
      modal.show();
      console.log('è‡ªå‹•å‚™ä»½å®Œæˆï¼Œæç¤ºç”¨æˆ¶ä¸‹è¼‰ã€‚');
    }

    // è§¸ç™¼è‡ªå‹•å‚™ä»½ä¸‹è¼‰
    function triggerAutoBackupDownload() {
      // èª¿ç”¨ç¾æœ‰çš„ backup å‡½æ•¸ä¾†åŸ·è¡Œä¸‹è¼‰
      backup();
      // é—œé–‰ Modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('autoBackupReadyModal'));
      modal.hide();
    }

    // æ–°å¢å ±è¡¨ç›¸é—œå‡½æ•¸
    function showDailyReport() {
      const today = new Date();
      // ä½¿ç”¨æœ¬åœ°æ™‚é–“
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      const formattedDate = `${year}-${month}-${day}`;
      document.getElementById('dailyReportDate').value = formattedDate;
      updateDailyReport();
      new bootstrap.Modal(document.getElementById('dailyReportModal')).show();
    }

    function showMonthlyReport() {
      const today = new Date();
      // ä½¿ç”¨æœ¬åœ°æ™‚é–“
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const yearMonth = `${year}-${month}`;
      document.getElementById('monthlyReportMonth').value = yearMonth;
      updateMonthlyReport();
      new bootstrap.Modal(document.getElementById('monthlyReportModal')).show();
    }

    function parseChineseDateTime(timeStr) {
      if (!timeStr) return new Date('invalid');
      
      // å˜—è©¦è§£ææ¨™æº–æ ¼å¼ (YYYY/MM/DD HH:mm:ss)
      const standardMatch = timeStr.match(/(\d{4})\/(\d{1,2})\/(\d{1,2})\s+(\d{2}):(\d{2}):(\d{2})/);
      if (standardMatch) {
        const [_, year, month, day, hour, minute, second] = standardMatch;
        return new Date(year, month - 1, day, hour, minute, second);
      }
      
      // å˜—è©¦è§£æä¸­æ–‡æ ¼å¼ (YYYYå¹´MMæœˆDDæ—¥ HH:mm:ss)
      const chineseMatch = timeStr.match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥\s+(\d{2}):(\d{2}):(\d{2})/);
      if (chineseMatch) {
        const [_, year, month, day, hour, minute, second] = chineseMatch;
        return new Date(year, month - 1, day, hour, minute, second);
      }
      
      // å˜—è©¦æ¨™æº–çš„ Date è§£æ
      const date = new Date(timeStr);
      return isNaN(date.getTime()) ? new Date('invalid') : date;
    }

    function updateDailyReport() {
      const date = document.getElementById('dailyReportDate').value;
      const data = getData();
      const reportDate = new Date(date);
      
      // æ”¶é›†ç•¶å¤©çš„æ‰€æœ‰è¨˜éŒ„
      const dailyRecords = [];
      Object.entries(data).forEach(([name, customer]) => {
        customer.log.forEach(log => {
          let logDate, count, isAdd, productType;
          
          try {
            if (typeof log === 'string') {
              const timeMatch = log.match(/ï¼ˆ(.*?)ï¼‰/);
              if (!timeMatch) return;
              
              const timeStr = timeMatch[1];
              logDate = parseChineseDateTime(timeStr);
              
              if (isNaN(logDate.getTime())) {
                console.warn('ç„¡æ³•è§£ææ™‚é–“:', timeStr);
                return;
              }

              const countMatch = log.match(/([+-]\d+)/);
              if (!countMatch) return;
              
              isAdd = log.startsWith('+');
              count = Math.abs(parseInt(countMatch[1]));
              productType = log.includes('æ¯') ? log.split('æ¯')[1].trim().split('ï¼ˆ')[0].trim() : 'æœªæŒ‡å®š';
            } else if (typeof log === 'object' && log !== null) {
              if (!log.timestamp) return;
              
              logDate = parseChineseDateTime(log.timestamp);
              if (isNaN(logDate.getTime())) {
                console.warn('ç„¡æ³•è§£ææ™‚é–“æˆ³è¨˜:', log.timestamp);
                return;
              }
              
              isAdd = log.type === 'add';
              count = Math.abs(log.count || 0);
              productType = log.productType || 'æœªæŒ‡å®š';
            } else {
              return;
            }

            // æª¢æŸ¥æ—¥æœŸæ˜¯å¦åŒ¹é…
            if (logDate.toDateString() === reportDate.toDateString()) {
              dailyRecords.push({
                name,
                log: typeof log === 'string' ? log : `${isAdd ? '+' : '-'}${count} æ¯ ${productType}ï¼ˆ${log.timestamp}ï¼‰`,
                productType,
                isAdd,
                count,
                timestamp: logDate
              });
            }
          } catch (error) {
            console.error('è™•ç†æ—¥èªŒè¨˜éŒ„æ™‚å‡ºéŒ¯:', error, log);
          }
        });
      });

      // ç”Ÿæˆå ±è¡¨å…§å®¹
      let content = `
        <h6 class="mb-3">${reportDate.toLocaleDateString('zh-TW')} ç‡Ÿæ¥­å ±è¡¨</h6>
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>æ™‚é–“</th>
                <th>é¡§å®¢</th>
                <th>å•†å“é¡å‹</th>
                <th>æ“ä½œ</th>
                <th>æ•¸é‡</th>
              </tr>
            </thead>
            <tbody>
      `;

      // æŒ‰æ™‚é–“æ’åº
      dailyRecords.sort((a, b) => a.timestamp - b.timestamp);

      let totalAdd = 0;
      let totalRemove = 0;

      dailyRecords.forEach(record => {
        const time = record.timestamp.toLocaleTimeString('zh-TW', { 
          hour: '2-digit', 
          minute: '2-digit',
          second: '2-digit',
          hour12: false 
        });
        content += `
          <tr>
            <td>${time}</td>
            <td>${record.name}</td>
            <td>${record.productType}</td>
            <td>${record.isAdd ? 'åŠ æ¯' : 'æ‰£æ¯'}</td>
            <td>${record.count}</td>
          </tr>
        `;
        if (record.isAdd) {
          totalAdd += record.count;
        } else {
          totalRemove += record.count;
        }
      });

      content += `
            </tbody>
            <tfoot>
              <tr class="table-info">
                <td colspan="3"><strong>ç•¶æ—¥çµ±è¨ˆ</strong></td>
                <td>åŠ æ¯ç¸½æ•¸</td>
                <td>${totalAdd}</td>
              </tr>
              <tr class="table-warning">
                <td colspan="3"></td>
                <td>æ‰£æ¯ç¸½æ•¸</td>
                <td>${totalRemove}</td>
              </tr>
              <tr class="table-primary">
                <td colspan="3"></td>
                <td>æ·¨å¢åŠ </td>
                <td>${totalAdd - totalRemove}</td>
              </tr>
            </tfoot>
          </table>
        </div>
      `;

      document.getElementById('dailyReportContent').innerHTML = content;
    }

    function updateMonthlyReport() {
      const yearMonth = document.getElementById('monthlyReportMonth').value;
      const [year, month] = yearMonth.split('-').map(Number);
      const data = getData();
      
      // æ”¶é›†è©²æœˆçš„æ‰€æœ‰è¨˜éŒ„
      const monthlyRecords = [];
      Object.entries(data).forEach(([name, customer]) => {
        customer.log.forEach(log => {
          let logDate, count, isAdd, productType;
          
          try {
            if (typeof log === 'string') {
              const timeMatch = log.match(/ï¼ˆ(.*?)ï¼‰/);
              if (!timeMatch) return;
              
              const timeStr = timeMatch[1];
              logDate = parseChineseDateTime(timeStr);
              
              if (isNaN(logDate.getTime())) {
                console.warn('ç„¡æ³•è§£ææ™‚é–“:', timeStr);
                return;
              }

              const countMatch = log.match(/([+-]\d+)/);
              if (!countMatch) return;
              
              isAdd = log.startsWith('+');
              count = Math.abs(parseInt(countMatch[1]));
              productType = log.includes('æ¯') ? log.split('æ¯')[1].trim().split('ï¼ˆ')[0].trim() : 'æœªæŒ‡å®š';
            } else if (typeof log === 'object' && log !== null) {
              if (!log.timestamp) return;
              
              logDate = parseChineseDateTime(log.timestamp);
              if (isNaN(logDate.getTime())) {
                console.warn('ç„¡æ³•è§£ææ™‚é–“æˆ³è¨˜:', log.timestamp);
                return;
              }
              
              isAdd = log.type === 'add';
              count = Math.abs(log.count || 0);
              productType = log.productType || 'æœªæŒ‡å®š';
            } else {
              return;
            }

            // æª¢æŸ¥æ—¥æœŸæ˜¯å¦åœ¨æŒ‡å®šæœˆä»½
            if (logDate.getFullYear() === year && logDate.getMonth() + 1 === month) {
              monthlyRecords.push({
                name,
                log: typeof log === 'string' ? log : `${isAdd ? '+' : '-'}${count} æ¯ ${productType}ï¼ˆ${log.timestamp}ï¼‰`,
                productType,
                isAdd,
                count,
                date: logDate
              });
            }
          } catch (error) {
            console.error('è™•ç†æ—¥èªŒè¨˜éŒ„æ™‚å‡ºéŒ¯:', error, log);
          }
        });
      });

      // ç”Ÿæˆå ±è¡¨å…§å®¹
      let content = `
        <h6 class="mb-3">${year}å¹´${month}æœˆç‡Ÿæ¥­å ±è¡¨</h6>
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>æ—¥æœŸ</th>
                <th>å•†å“é¡å‹</th>
                <th>åŠ æ¯æ•¸</th>
                <th>æ‰£æ¯æ•¸</th>
                <th>æ·¨å¢åŠ </th>
              </tr>
            </thead>
            <tbody>
      `;

      // æŒ‰æ—¥æœŸå’Œå•†å“é¡å‹åˆ†çµ„çµ±è¨ˆ
      const dailyStats = {};
      monthlyRecords.forEach(record => {
        const date = record.date.toLocaleDateString('zh-TW');
        if (!dailyStats[date]) {
          dailyStats[date] = {};
        }
        if (!dailyStats[date][record.productType]) {
          dailyStats[date][record.productType] = { add: 0, remove: 0 };
        }
        if (record.isAdd) {
          dailyStats[date][record.productType].add += record.count;
        } else {
          dailyStats[date][record.productType].remove += record.count;
        }
      });

      // æŒ‰æ—¥æœŸæ’åº
      const sortedDates = Object.keys(dailyStats).sort((a, b) => new Date(a) - new Date(b));
      
      let totalAdd = 0;
      let totalRemove = 0;
      const productTypeStats = {};

      sortedDates.forEach(date => {
        const productTypes = Object.keys(dailyStats[date]);
        productTypes.forEach(productType => {
          const stats = dailyStats[date][productType];
          const netChange = stats.add - stats.remove;
          
          if (!productTypeStats[productType]) {
            productTypeStats[productType] = { add: 0, remove: 0 };
          }
          productTypeStats[productType].add += stats.add;
          productTypeStats[productType].remove += stats.remove;

          content += `
            <tr>
              <td>${date}</td>
              <td>${productType}</td>
              <td>${stats.add}</td>
              <td>${stats.remove}</td>
              <td>${netChange}</td>
            </tr>
          `;

          totalAdd += stats.add;
          totalRemove += stats.remove;
        });
      });

      // æ·»åŠ å•†å“é¡å‹çµ±è¨ˆ
      content += `
            </tbody>
            <tfoot>
              <tr class="table-info">
                <td colspan="2"><strong>å•†å“é¡å‹çµ±è¨ˆ</strong></td>
                <td colspan="3"></td>
              </tr>
      `;

      Object.entries(productTypeStats).forEach(([productType, stats]) => {
        const netChange = stats.add - stats.remove;
        content += `
          <tr class="table-light">
            <td colspan="2">${productType}</td>
            <td>${stats.add}</td>
            <td>${stats.remove}</td>
            <td>${netChange}</td>
          </tr>
        `;
      });

      content += `
              <tr class="table-primary">
                <td colspan="2"><strong>æœˆçµçµ±è¨ˆ</strong></td>
                <td>${totalAdd}</td>
                <td>${totalRemove}</td>
                <td>${totalAdd - totalRemove}</td>
              </tr>
            </tfoot>
          </table>
        </div>
      `;

      document.getElementById('monthlyReportContent').innerHTML = content;
    }

    // æ–°å¢è½‰æ›èˆŠè³‡æ–™æ ¼å¼çš„å‡½æ•¸
    function convertOldDataFormat() {
      const data = getData();
      let hasChanges = false;

      Object.entries(data).forEach(([name, customer]) => {
        if (!customer.log) return;

        customer.log = customer.log.map(log => {
          if (typeof log !== 'string') return log;

          try {
            // æª¢æŸ¥æ˜¯å¦åŒ…å«ä¸Šåˆ/ä¸‹åˆ
            if (log.includes('ä¸Šåˆ') || log.includes('ä¸‹åˆ')) {
              hasChanges = true;
              const timeMatch = log.match(/ï¼ˆ(.*?)ï¼‰/);
              if (!timeMatch) return log;

              const oldTimeStr = timeMatch[1];
              console.log('è™•ç†æ™‚é–“å­—ä¸²:', oldTimeStr); // èª¿è©¦ä¿¡æ¯

              const [datePart, timePart] = oldTimeStr.split(' ');
              if (!datePart || !timePart) {
                console.warn('ç„¡æ³•åˆ†å‰²æ—¥æœŸå’Œæ™‚é–“:', oldTimeStr);
                return log;
              }

              // è§£ææ—¥æœŸéƒ¨åˆ†
              const [year, month, day] = datePart.split('/').map(num => parseInt(num, 10));
              if (isNaN(year) || isNaN(month) || isNaN(day)) {
                console.warn('æ—¥æœŸè§£æå¤±æ•—:', datePart);
                return log;
              }

              // è§£ææ™‚é–“éƒ¨åˆ†
              const [time, period] = timePart.split(' ');
              if (!time) {
                console.warn('ç„¡æ³•è§£ææ™‚é–“éƒ¨åˆ†:', timePart);
                return log;
              }

              let [hour, minute, second] = time.split(':').map(num => parseInt(num, 10));
              if (isNaN(hour) || isNaN(minute) || isNaN(second)) {
                console.warn('æ™‚é–“è§£æå¤±æ•—:', time);
                return log;
              }

              // è½‰æ›ä¸Šåˆ/ä¸‹åˆç‚º24å°æ™‚åˆ¶
              if (period === 'ä¸‹åˆ' && hour !== 12) {
                hour += 12;
              } else if (period === 'ä¸Šåˆ' && hour === 12) {
                hour = 0;
              }

              // ç¢ºä¿æ‰€æœ‰æ•¸å­—éƒ½æ˜¯æœ‰æ•ˆçš„
              if (isNaN(hour) || isNaN(minute) || isNaN(second)) {
                console.warn('è½‰æ›å¾Œæ™‚é–“ç„¡æ•ˆ:', { hour, minute, second });
                return log;
              }

              // æ ¼å¼åŒ–æ–°çš„æ™‚é–“å­—ä¸²
              const newTimeStr = `${year}/${String(month).padStart(2, '0')}/${String(day).padStart(2, '0')} ${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}:${String(second).padStart(2, '0')}`;
              console.log('è½‰æ›å¾Œæ™‚é–“:', newTimeStr); // èª¿è©¦ä¿¡æ¯
              return log.replace(timeMatch[0], `ï¼ˆ${newTimeStr}ï¼‰`);
            }

            // æª¢æŸ¥æ˜¯å¦ç‚ºä¸­æ–‡æ—¥æœŸæ ¼å¼ (YYYYå¹´MMæœˆDDæ—¥)
            if (log.includes('å¹´')) {
              hasChanges = true;
              const timeMatch = log.match(/ï¼ˆ(.*?)ï¼‰/);
              if (!timeMatch) return log;

              const oldTimeStr = timeMatch[1];
              console.log('è™•ç†ä¸­æ–‡æ™‚é–“å­—ä¸²:', oldTimeStr); // èª¿è©¦ä¿¡æ¯

              const [datePart, timePart] = oldTimeStr.split(' ');
              if (!datePart || !timePart) {
                console.warn('ç„¡æ³•åˆ†å‰²ä¸­æ–‡æ—¥æœŸå’Œæ™‚é–“:', oldTimeStr);
                return log;
              }

              // è§£æä¸­æ–‡æ—¥æœŸ
              const year = parseInt(datePart.match(/(\d{4})å¹´/)?.[1], 10);
              const month = parseInt(datePart.match(/(\d{1,2})æœˆ/)?.[1], 10);
              const day = parseInt(datePart.match(/(\d{1,2})æ—¥/)?.[1], 10);

              if (isNaN(year) || isNaN(month) || isNaN(day)) {
                console.warn('ä¸­æ–‡æ—¥æœŸè§£æå¤±æ•—:', datePart);
                return log;
              }

              // è§£ææ™‚é–“éƒ¨åˆ†
              let [hour, minute, second] = timePart.split(':').map(num => parseInt(num, 10));
              if (isNaN(hour) || isNaN(minute) || isNaN(second)) {
                console.warn('ä¸­æ–‡æ™‚é–“è§£æå¤±æ•—:', timePart);
                return log;
              }

              // æ ¼å¼åŒ–æ–°çš„æ™‚é–“å­—ä¸²
              const newTimeStr = `${year}/${String(month).padStart(2, '0')}/${String(day).padStart(2, '0')} ${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}:${String(second).padStart(2, '0')}`;
              console.log('è½‰æ›å¾Œä¸­æ–‡æ™‚é–“:', newTimeStr); // èª¿è©¦ä¿¡æ¯
              return log.replace(timeMatch[0], `ï¼ˆ${newTimeStr}ï¼‰`);
            }

            // æª¢æŸ¥æ˜¯å¦ç‚ºæ¨™æº–æ ¼å¼ä½†æ™‚é–“ç„¡æ•ˆ
            const timeMatch = log.match(/ï¼ˆ(.*?)ï¼‰/);
            if (timeMatch) {
              const timeStr = timeMatch[1];
              if (timeStr.includes('NaN')) {
                console.warn('ç™¼ç¾ç„¡æ•ˆæ™‚é–“æ ¼å¼:', timeStr);
                // å˜—è©¦ä¿®å¾©ç„¡æ•ˆçš„æ™‚é–“
                const [datePart, timePart] = timeStr.split(' ');
                if (datePart && timePart) {
                  const [year, month, day] = datePart.split('/').map(num => parseInt(num, 10));
                  const [hour, minute, second] = timePart.split(':').map(num => {
                    const parsed = parseInt(num, 10);
                    return isNaN(parsed) ? 0 : parsed;
                  });
                  
                  if (!isNaN(year) && !isNaN(month) && !isNaN(day)) {
                    const newTimeStr = `${year}/${String(month).padStart(2, '0')}/${String(day).padStart(2, '0')} ${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}:${String(second).padStart(2, '0')}`;
                    console.log('ä¿®å¾©ç„¡æ•ˆæ™‚é–“:', newTimeStr);
                    hasChanges = true;
                    return log.replace(timeMatch[0], `ï¼ˆ${newTimeStr}ï¼‰`);
                  }
                }
              }
            }

            return log;
          } catch (error) {
            console.error('è™•ç†æ—¥èªŒæ™‚å‡ºéŒ¯:', error, log);
            return log;
          }
        });
      });

      if (hasChanges) {
        saveData(data);
        console.log('å·²å°‡èˆŠçš„è³‡æ–™æ ¼å¼è½‰æ›ç‚º24å°æ™‚åˆ¶');
      }
    }

    // ä¿®æ”¹åˆå§‹åŒ–éƒ¨åˆ†
    document.addEventListener('DOMContentLoaded', () => {
      // è½‰æ›èˆŠçš„è³‡æ–™æ ¼å¼
      convertOldDataFormat();

      // è¼‰å…¥ä¸¦æ‡‰ç”¨æ·±è‰²æ¨¡å¼è¨­å®š
      const darkModeEnabled = localStorage.getItem('darkModeEnabled') === 'true';
      applyDarkMode(darkModeEnabled);

      // è¼‰å…¥ä¸¦å•Ÿå‹•è‡ªå‹•å‚™ä»½
      const savedInterval = localStorage.getItem('autoBackupInterval') || '1';
      setAutoBackupInterval(parseInt(savedInterval));

      // åˆå§‹åŒ–å•†å“é¡å‹é¸æ“‡å™¨
      updateProductTypeSelects();

      // åˆå§‹åŒ–æ™‚æ ¹æ“šè¨­å®šæ¸²æŸ“
      render();
    });

    // æ–°å¢å¿«é€Ÿè·³è½‰åˆ°ä»Šå¤©çš„å‡½æ•¸
    function showTodayReport() {
      const today = new Date();
      // ä½¿ç”¨æœ¬åœ°æ™‚é–“
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      const formattedDate = `${year}-${month}-${day}`;
      document.getElementById('dailyReportDate').value = formattedDate;
      updateDailyReport();
    }

    // æ–°å¢å¿«é€Ÿè·³è½‰åˆ°ç•¶æœˆçš„å‡½æ•¸
    function showCurrentMonthReport() {
      const today = new Date();
      // ä½¿ç”¨æœ¬åœ°æ™‚é–“
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const yearMonth = `${year}-${month}`;
      document.getElementById('monthlyReportMonth').value = yearMonth;
      updateMonthlyReport();
    }

    // PWA: è¨»å†Š service worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('./service-worker.js').then(function(registration) {
          console.log('ServiceWorker è¨»å†ŠæˆåŠŸ:', registration.scope);
        }, function(err) {
          console.log('ServiceWorker è¨»å†Šå¤±æ•—:', err);
        });
      });
    }

    // æª¢æŸ¥æ›´æ–°ç›¸é—œå‡½æ•¸
    let updateAvailable = false;
    let newVersion = '';
    let lastCheckTime = localStorage.getItem('lastUpdateCheck') || 0;
    const CHECK_INTERVAL = 1000 * 60 * 60; // æ¯å°æ™‚æª¢æŸ¥ä¸€æ¬¡ï¼ˆå¯èª¿æ•´ï¼‰
    let isCheckingForUpdates = false; // æ–°å¢æ——æ¨™é¿å…é‡è¤‡æª¢æŸ¥

    // æ›´æ–°æœ€å¾Œæª¢æŸ¥æ™‚é–“é¡¯ç¤º
    function updateLastCheckTimeDisplay() {
      const lastCheck = localStorage.getItem('lastUpdateCheck');
      const lastCheckTimeElement = document.getElementById('lastCheckTime');
      if (lastCheck) {
        const date = new Date(parseInt(lastCheck));
        lastCheckTimeElement.textContent = date.toLocaleString();
      } else {
        lastCheckTimeElement.textContent = 'å°šæœªæª¢æŸ¥';
      }
    }

    // ä¿®æ”¹ checkForUpdates å‡½æ•¸ï¼ŒåŠ å…¥æ›´æ–°é¡¯ç¤ºæ™‚é–“
    async function checkForUpdates(silent = false) {
      // å¦‚æœæ­£åœ¨æª¢æŸ¥ï¼Œå‰‡ç›´æ¥è¿”å›
      if (isCheckingForUpdates) {
        console.log('Already checking for updates.');
        if (!silent) showToast('æ­£åœ¨æª¢æŸ¥æ›´æ–°ï¼Œè«‹ç¨å€™...', 'info');
        return;
      }

      isCheckingForUpdates = true; // è¨­å®šç‚ºæ­£åœ¨æª¢æŸ¥

      try {
        const now = Date.now();
        const timeSinceLastCheck = now - lastCheckTime;

        // å°æ–¼ééœé»˜æª¢æŸ¥ (æ‰‹å‹•é»æ“Š)ï¼Œåªæœ‰åœ¨è·é›¢ä¸Šæ¬¡æ‰‹å‹•æª¢æŸ¥è¶…éä¸€å€‹è¼ƒçŸ­æ™‚é–“ï¼ˆä¾‹å¦‚ 10 ç§’ï¼‰æ‰åŸ·è¡Œï¼Œé¿å…èª¤è§¸é€£é»
        // å°æ–¼è‡ªå‹•æª¢æŸ¥ (éœé»˜)ï¼Œéµå®ˆ CHECK_INTERVAL
        const manualCheckInterval = 10000; // æ‰‹å‹•æª¢æŸ¥é–“éš” 10 ç§’

        if (!silent && timeSinceLastCheck < manualCheckInterval) {
            console.log(`Manual check too soon (${timeSinceLastCheck}ms since last check). Minimum interval: ${manualCheckInterval}ms`);
            showToast(`è«‹ç¨å€™å†è©¦ã€‚ä¸Šæ¬¡æª¢æŸ¥æ–¼ ${Math.floor(timeSinceLastCheck / 1000)} ç§’å‰ã€‚`, 'warning');
            isCheckingForUpdates = false;
            return;
        } else if (silent && timeSinceLastCheck < CHECK_INTERVAL) {
            console.log(`Silent check interval not met (${timeSinceLastCheck}ms since last check). Minimum interval: ${CHECK_INTERVAL}ms`);
            isCheckingForUpdates = false;
            return;
        }

        // åªæœ‰åœ¨ééœé»˜æ¨¡å¼ä¸‹æ‰é¡¯ç¤ºæª¢æŸ¥ä¸­çš„æç¤º
        if (!silent) {
            showToast('æ­£åœ¨æª¢æŸ¥æ›´æ–°...', 'info');
        }

        // æ›´æ–°æœ€å¾Œæª¢æŸ¥æ™‚é–“ï¼ˆæ‰‹å‹•å’Œè‡ªå‹•æª¢æŸ¥éƒ½æœƒæ›´æ–°æ™‚é–“ï¼‰
        lastCheckTime = now;
        localStorage.setItem('lastUpdateCheck', now);
        updateLastCheckTimeDisplay(); // Update display immediately after setting new time
        
        // ç²å– manifest.json
        // åŠ å…¥æ™‚é–“æˆ³é¿å…ç€è¦½å™¨å¿«å–
        const response = await fetch('./manifest.json?t=' + now);
        if (!response.ok) {
            // å¦‚æœ manifest.json ç„¡æ³•è¨ªå• (ä¾‹å¦‚ 404)ï¼Œä¸è¦–ç‚ºæ›´æ–°éŒ¯èª¤ï¼Œå¯èƒ½æ˜¯ PWA å®‰è£åœ¨éæ ¹ç›®éŒ„
            console.warn(`Failed to fetch manifest.json: status ${response.status}`);
            if (!silent && response.status !== 404) {
                 showToast(`æª¢æŸ¥æ›´æ–°å¤±æ•—ï¼šç„¡æ³•ç²å– manifest.json (ç‹€æ…‹ç¢¼: ${response.status})`, 'danger');
            }
             isCheckingForUpdates = false;
            return; // ç„¡æ³•ç²å– manifestï¼ŒçµæŸæª¢æŸ¥
        }
        const manifest = await response.json();
        
        // ç²å–ç•¶å‰ç‰ˆæœ¬
        const currentVersionElement = document.getElementById('currentVersion');
        const currentVersion = currentVersionElement ? currentVersionElement.textContent : '-';

        console.log(`Current version: ${currentVersion}, Manifest version: ${manifest.version}`); // Debug line
        
        // æ¯”è¼ƒç‰ˆæœ¬
        if (manifest.version && manifest.version !== currentVersion) {
          updateAvailable = true;
          newVersion = manifest.version;
          
          // æ›´æ–°ç‰ˆæœ¬è™Ÿé¡¯ç¤ºåœ¨ Modal ä¸­
          const currentVersionModalElement = document.getElementById('currentVersionModal');
          const newVersionModalElement = document.getElementById('newVersionModal');
          if (currentVersionModalElement) currentVersionModalElement.textContent = currentVersion;
          if (newVersionModalElement) newVersionModalElement.textContent = newVersion;

          // æ›´æ–°ç•¶å‰ç‰ˆæœ¬è™Ÿé¡¯ç¤º
          if (currentVersionElement) {
            currentVersionElement.textContent = manifest.version;
          }

          // é¡¯ç¤ºæ›´æ–°æç¤º Modal
          const updateModal = new bootstrap.Modal(document.getElementById('updateModal'));
          updateModal.show();

          // å„²å­˜æ–°ç‰ˆæœ¬è™Ÿåˆ° localStorage
          localStorage.setItem('appVersion', manifest.version);

        } else if (!silent) {
          showToast('æ‚¨ç›®å‰ä½¿ç”¨çš„æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼');
        } else {
             console.log('Auto check: already on latest version.'); // Debug line for silent checks
        }
      } catch (error) {
        console.error('æª¢æŸ¥æ›´æ–°æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š', error);
        if (!silent) {
          showToast('æª¢æŸ¥æ›´æ–°æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'danger');
        }
      } finally {
          isCheckingForUpdates = false; // æª¢æŸ¥çµæŸ
      }
    }

    // è‡ªå‹•æª¢æŸ¥æ›´æ–°
    function startAutoUpdateCheck() {
      // é é¢è¼‰å…¥æ™‚æª¢æŸ¥ä¸€æ¬¡
      checkForUpdates(true);
      
      // è¨­å®šå®šæœŸæª¢æŸ¥
      setInterval(() => {
        checkForUpdates(true);
      }, CHECK_INTERVAL);
      
      // ç•¶é é¢é‡æ–°ç²å¾—ç„¦é»æ™‚æª¢æŸ¥
      window.addEventListener('focus', () => {
        checkForUpdates(true);
      });
    }

    // åœ¨ Service Worker è¨»å†Šæ™‚å•Ÿå‹•è‡ªå‹•æª¢æŸ¥
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          const registration = await navigator.serviceWorker.register('./service-worker.js');
          
          // å•Ÿå‹•è‡ªå‹•æª¢æŸ¥æ›´æ–°
          startAutoUpdateCheck();
          
          // ç›£è½ Service Worker æ›´æ–°
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                // æœ‰æ–°çš„ Service Worker å¯ç”¨
                updateAvailable = true;
                // é¡¯ç¤ºæ›´æ–°é€šçŸ¥
                if (confirm('ç™¼ç¾æ–°ç‰ˆæœ¬ï¼æ˜¯å¦è¦æ›´æ–°ï¼Ÿ')) {
                  window.location.reload();
                }
              }
            });
          });
        } catch (error) {
          console.error('Service Worker è¨»å†Šå¤±æ•—ï¼š', error);
        }
      });
    }

    // åœ¨é é¢è¼‰å…¥æ™‚æ›´æ–°é¡¯ç¤ºæ™‚é–“ï¼ˆç¢ºä¿é¡¯ç¤ºæ­£ç¢ºçš„ä¸Šæ¬¡æª¢æŸ¥æ™‚é–“ï¼‰
    window.addEventListener('load', () => {
      updateLastCheckTimeDisplay();
    });

    // å„²å­˜è¨­å®šå‡½æ•¸ (éœ€è¦æ‚¨æ ¹æ“šå¯¦éš›çš„è¨­å®šé …ç›®ä¾†å¯¦ç¾)
    function saveSettings() {
      try {
        const autoBackupInterval = document.getElementById('autoBackupIntervalInput').value;
        const enablePredictiveSorting = document.getElementById('enablePredictiveSorting').checked;
        const enableDarkMode = document.getElementById('enableDarkMode').checked;
        const enableDailyReport = document.getElementById('enableDailyReport').checked;
        const enableMonthlyReport = document.getElementById('enableMonthlyReport').checked;

        localStorage.setItem('autoBackupInterval', autoBackupInterval);
        localStorage.setItem('enablePredictiveSorting', enablePredictiveSorting);
        localStorage.setItem('enableDarkMode', enableDarkMode);
        localStorage.setItem('enableDailyReport', enableDailyReport);
        localStorage.setItem('enableMonthlyReport', enableMonthlyReport);

        // æ‚¨å¯èƒ½é‚„éœ€è¦å„²å­˜å•†å“é¡å‹åˆ—è¡¨
        // ... å„²å­˜å•†å“é¡å‹åˆ—è¡¨çš„é‚è¼¯ ...
        // é€™è£¡éœ€è¦èª¿ç”¨ä¸€å€‹å‡½æ•¸ä¾†ç²å–ä¸¦å„²å­˜å•†å“é¡å‹åˆ—è¡¨
        saveProductTypes(); // å‡è¨­æ‚¨æœ‰ä¸€å€‹ saveProductTypes å‡½æ•¸ä¾†è™•ç†å•†å“é¡å‹çš„å„²å­˜

        showToast('è¨­å®šå·²å„²å­˜ï¼');
        // å„²å­˜å¾Œé—œé–‰ Modal
        const settingsModal = bootstrap.Modal.getInstance(document.getElementById('settingsModal'));
        if (settingsModal) {
          settingsModal.hide();
        }

         // æ‡‰ç”¨æ·±è‰²æ¨¡å¼è¨­å®š
        if (enableDarkMode) {
            document.body.classList.add('dark-mode');
        } else {
            document.body.classList.remove('dark-mode');
        }

      } catch (error) {
        console.error('å„²å­˜è¨­å®šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š', error);
        showToast('å„²å­˜è¨­å®šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'danger');
      }
    }

    // åœ¨ Modal è¼‰å…¥æ™‚è®€å–è¨­å®š (éœ€è¦æ‚¨æ ¹æ“šå¯¦éš›çš„è¨­å®šé …ç›®ä¾†å¯¦ç¾)
    document.getElementById('settingsModal').addEventListener('show.bs.modal', function () {
      try {
        const autoBackupInterval = localStorage.getItem('autoBackupInterval') || '1';
        const enablePredictiveSorting = localStorage.getItem('enablePredictiveSorting') === 'true';
        const enableDarkMode = localStorage.getItem('enableDarkMode') === 'true';
        const enableDailyReport = localStorage.getItem('enableDailyReport') === 'true';
        const enableMonthlyReport = localStorage.getItem('enableMonthlyReport') === 'true';

        document.getElementById('autoBackupIntervalInput').value = autoBackupInterval;
        document.getElementById('enablePredictiveSorting').checked = enablePredictiveSorting;
        document.getElementById('enableDarkMode').checked = enableDarkMode;
        document.getElementById('enableDailyReport').checked = enableDailyReport;
        document.getElementById('enableMonthlyReport').checked = enableMonthlyReport;

        // è¼‰å…¥å•†å“é¡å‹åˆ—è¡¨
         loadProductTypes();

         // æ‡‰ç”¨æ·±è‰²æ¨¡å¼è¨­å®š
        if (enableDarkMode) {
            document.body.classList.add('dark-mode');
        } else {
            document.body.classList.remove('dark-mode');
        }

      } catch (error) {
        console.error('è¼‰å…¥è¨­å®šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š', error);
        showToast('è¼‰å…¥è¨­å®šæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'danger');
      }
    });

    // åœ¨é é¢è¼‰å…¥æ™‚æ‡‰ç”¨æ·±è‰²æ¨¡å¼è¨­å®šä¸¦æ›´æ–°å•†å“é¡å‹ä¸‹æ‹‰é¸å–®
    window.addEventListener('load', () => {
      const enableDarkMode = localStorage.getItem('enableDarkMode') === 'true';
      if (enableDarkMode) {
        document.body.classList.add('dark-mode');
      }
      updateLastCheckTimeDisplay(); // ä¿è­‰ä¸Šæ¬¡æª¢æŸ¥æ™‚é–“é¡¯ç¤ºæ­£ç¢º
      updateProductTypeSelects(); // é é¢è¼‰å…¥æ™‚æ›´æ–°å•†å“é¡å‹ä¸‹æ‹‰é¸å–®
    });

    // éš±è—è¨­å®š Modal çš„å‡½æ•¸
    function hideSettingsModal() {
      const settingsModal = bootstrap.Modal.getInstance(document.getElementById('settingsModal'));
      if (settingsModal) {
        settingsModal.hide();
      }
    }

    // Service Worker è¨»å†ŠåŠæ›´æ–°è™•ç†
    let newServiceWorker = null;

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          const registration = await navigator.serviceWorker.register('./service-worker.js');

          console.log('Service Worker è¨»å†ŠæˆåŠŸï¼š', registration);

          // ç›£è½ Service Worker æ›´æ–°
          registration.addEventListener('updatefound', () => {
            console.log('Service Worker updatefound event detected.');
            newServiceWorker = registration.installing;

            newServiceWorker.addEventListener('statechange', () => {
              console.log('Service Worker state changed:', newServiceWorker.state);
              if (newServiceWorker.state === 'installed' && navigator.serviceWorker.controller) {
                // æœ‰æ–°çš„ Service Worker å®‰è£å®Œæˆä¸¦åœ¨ç­‰å¾…ä¸­
                console.log('New Service Worker installed and waiting.');
                
                // å˜—è©¦ç²å–æ–°ç‰ˆæœ¬è™Ÿä¸¦é¡¯ç¤º Modal
                // ... existing code to fetch manifest and show modal ...

                 // é¡¯ç¤ºæ›´æ–°æç¤º Modal
                const updateModalElement = document.getElementById('updateModal');
                if (updateModalElement) {
                     const updateModal = new bootstrap.Modal(updateModalElement);
                     updateModal.show();
                } else {
                    console.error('Update modal element not found.');
                }
              }
            });
          });

          // æª¢æŸ¥æ˜¯å¦æœ‰ç­‰å¾…ä¸­çš„æ›´æ–°ï¼ˆä½¿ç”¨è€…ä¹‹å‰é—œé–‰äº†æ‡‰ç”¨ç¨‹å¼ï¼‰
          if (registration.waiting) {
              newServiceWorker = registration.waiting;
              console.log('Found waiting Service Worker from previous session.', newServiceWorker);
               // é¡¯ç¤ºæ›´æ–°æç¤º Modal
               // ... existing code to fetch manifest and show modal ...

              const updateModalElement = document.getElementById('updateModal');
                if (updateModalElement) {
                     const updateModal = new bootstrap.Modal(updateModalElement);
                     updateModal.show();
                } else {
                    console.error('Update modal element not found.');
                }
          }

           // å•Ÿå‹•è‡ªå‹•æª¢æŸ¥æ›´æ–°ï¼ˆå¯ä»¥ä¿ç•™ï¼Œå®ƒç”¨æ–¼è¨­å®šä¸­çš„æ‰‹å‹•æª¢æŸ¥å’Œå®šæ™‚æª¢æŸ¥ï¼Œä½† Service Worker æœ¬èº«ä¹Ÿæœƒæª¢æŸ¥ï¼‰
           startAutoUpdateCheck(); // æ ¹æ“šéœ€æ±‚æ±ºå®šæ˜¯å¦ä¿ç•™ï¼Œä¿ç•™çš„è©±å¯ä»¥æ›´å¿«åµæ¸¬åˆ° manifest çš„è®ŠåŒ–

        } catch (error) {
          console.error('Service Worker è¨»å†Šå¤±æ•—ï¼š', error);
          // å¦‚æœ Service Worker è¨»å†Šå¤±æ•—ï¼Œå½±éŸ¿ PWA åŠŸèƒ½ï¼Œå¯ä»¥è€ƒæ…®æç¤ºç”¨æˆ¶æˆ–è¨˜éŒ„æ—¥èªŒ
        }
      });

      // ç›£è½ Service Worker æ§åˆ¶æ¬Šè®ŠåŒ–ï¼ˆè¡¨ç¤ºæ–°çš„ Service Worker å·²ç¶“å•Ÿç”¨ï¼‰
      navigator.serviceWorker.addEventListener('controllerchange', () => {
          console.log('Controller changed, new Service Worker is active. Reloading page...');
           // é‡æ–°è¼‰å…¥é é¢ä»¥ä½¿ç”¨æ–°çš„ Service Worker æ§åˆ¶çš„æª”æ¡ˆ
          window.location.reload();
      });

    }

    // æ‡‰ç”¨æ›´æ–°ï¼ˆä½¿ç”¨è€…é»æ“Šæç¤ºæŒ‰éˆ•æ™‚è§¸ç™¼ï¼‰
    function applyUpdate() {
        console.log('applyUpdate called.');
        
        // é¡¯ç¤ºåŠ è¼‰å‹•ç•«
        const updateLoading = document.getElementById('updateLoading');
        updateLoading.classList.add('show');
        
        // éš±è— Modal
        const updateModalElement = document.getElementById('updateModal');
        const updateModal = bootstrap.Modal.getInstance(updateModalElement);
        if (updateModal) {
            console.log('Hiding update modal.');
            updateModal.hide();
        } else {
            console.log('Update modal instance not found.');
        }

        // å»¶é²åŸ·è¡Œæ›´æ–°æ“ä½œï¼Œè®“ç”¨æˆ¶çœ‹åˆ°åŠ è¼‰å‹•ç•«
        setTimeout(() => {
            // å¼·åˆ¶æ¸…é™¤å¿«å–ä¸¦é‡æ–°è¼‰å…¥
            if ('caches' in window) {
                caches.keys().then(function(names) {
                    for (let name of names) {
                        caches.delete(name);
                    }
                });
            }

            if (newServiceWorker) {
                console.log('Sending SKIP_WAITING message to newServiceWorker:', newServiceWorker);
                // é€šçŸ¥ Service Worker è·³éç­‰å¾…
                newServiceWorker.postMessage({ type: 'SKIP_WAITING' });
                
                // ç›£è½ Service Worker çš„ç‹€æ…‹è®ŠåŒ–
                newServiceWorker.addEventListener('statechange', () => {
                    if (newServiceWorker.state === 'activated') {
                        console.log('Service Worker activated, updating version number...');
                        // åªæœ‰åœ¨ Service Worker å®Œå…¨å•Ÿå‹•å¾Œæ‰æ›´æ–°ç‰ˆæœ¬è™Ÿ
                        const newVersion = document.getElementById('newVersionModal').textContent;
                        localStorage.setItem('appVersion', newVersion);
                        const currentVersionElement = document.getElementById('currentVersion');
                        if (currentVersionElement) {
                            currentVersionElement.textContent = newVersion;
                        }
                        // å¼·åˆ¶é‡æ–°è¼‰å…¥é é¢
                        window.location.reload(true);
                    }
                });
            } else {
                // å¦‚æœæ²’æœ‰æ–°çš„ Service Workerï¼Œç›´æ¥é‡æ–°è¼‰å…¥
                window.location.reload(true);
            }
        }, 1500); // å»¶é² 1.5 ç§’ï¼Œè®“ç”¨æˆ¶èƒ½çœ‹åˆ°åŠ è¼‰å‹•ç•«
    }

    // åœ¨é é¢è¼‰å…¥æ™‚æª¢æŸ¥ç‰ˆæœ¬è™Ÿ
    window.addEventListener('load', () => {
        const savedVersion = localStorage.getItem('appVersion');
        const currentVersionElement = document.getElementById('currentVersion');
        if (savedVersion && currentVersionElement) {
            currentVersionElement.textContent = savedVersion;
        }
    });
  </script>
</body>
</html>
