<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>顧客登入 - 寄杯管理系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/store.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h2 class="card-title text-center mb-4">顧客登入</h2>
                        <form id="loginForm" class="mb-4">
                            <div class="mb-3">
                                <label for="email" class="form-label">電子郵件</label>
                                <input type="email" class="form-control" id="email" required>
                            </div>
                            <div class="mb-3">
                                <label for="password" class="form-label">密碼</label>
                                <input type="password" class="form-control" id="password" required>
                            </div>
                            <div class="form-group">
                                <a href="#" onclick="window.forgotPassword()">忘記密碼？</a>
                            </div>
                            <button type="submit" class="btn btn-primary w-100 mb-3">登入</button>
                            <div class="text-center">
                                <a href="customer-register.html" class="text-decoration-none d-block mb-2">還沒有帳號？立即註冊</a>
                            </div>
                        </form>
                    </div>
                </div>
                <div id="errorMessage" class="alert alert-danger mt-4 d-none"></div>
                <div id="successMessage" class="alert alert-success mt-4 d-none"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-functions.js";

        // Firebase 配置
        const firebaseConfig = {
            apiKey: "AIzaSyDmK5gQ5VeqDYJw6xTh0fdGMW6wSVYrR8Y",
            authDomain: "number-79587.firebaseapp.com",
            projectId: "number-79587",
            storageBucket: "number-79587.firebasestorage.app",
            messagingSenderId: "779614466586",
            appId: "1:779614466586:web:9bcc9187dd3cbacb0917a3",
            measurementId: "G-VT1W90X55Z"
        };

        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const functions = getFunctions(app);

        // 註冊 Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker 註冊成功');
                    })
                    .catch(error => {
                        console.log('ServiceWorker 註冊失敗：', error);
                    });
            });
        }

        // 處理登入
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const errorMessage = document.getElementById('errorMessage');
            const successMessage = document.getElementById('successMessage');

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                console.log('登入成功');
                window.location.href = 'customer-dashboard.html';
            } catch (error) {
                console.error('登入失敗：', error);
                let errorMsg = '登入失敗：';
                switch (error.code) {
                    case 'auth/invalid-credential':
                        errorMsg += '電子郵件或密碼錯誤';
                        break;
                    case 'auth/user-not-found':
                        errorMsg += '找不到此用戶';
                        break;
                    case 'auth/wrong-password':
                        errorMsg += '密碼錯誤';
                        break;
                    case 'auth/invalid-email':
                        errorMsg += '無效的電子郵件格式';
                        break;
                    case 'auth/user-disabled':
                        errorMsg += '此帳號已被停用';
                        break;
                    case 'auth/too-many-requests':
                        errorMsg += '嘗試次數過多，請稍後再試';
                        break;
                    default:
                        errorMsg += error.message;
                }
                errorMessage.textContent = errorMsg;
                errorMessage.classList.remove('d-none');
                successMessage.classList.add('d-none');
            }
        });

        // 忘記密碼功能
        window.forgotPassword = async function() {
            const email = document.getElementById('email').value;
            if (!email) {
                alert('請輸入您的電子郵件地址');
                return;
            }

            try {
                const sendPasswordResetEmailFn = httpsCallable(functions, 'sendPasswordResetEmail');
                await sendPasswordResetEmailFn({ email });
                alert('密碼重設郵件已發送，請檢查您的電子郵件');
            } catch (error) {
                console.error('發送密碼重設郵件時出錯：', error);
                alert('發送密碼重設郵件失敗，請稍後再試');
            }
        };
    </script>
</body>
</html> 